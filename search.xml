<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[新版sentry安装配置]]></title>
      <url>http://yunsonbai.github.io/2017/03/24/new-sentry/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   前段时间搭建了sentry 7.x版本,运行了有一段时间了，现在日志来量有点大</span><br><span class="line">遇到了一个突出的问题：清理历史数据十分缓慢。最近在浏览sentry官方文档</span><br><span class="line">发现都已经更新到8.14.1了, 而且不在支持mysql, 官方给的解释:<span class="string">"Due to </span><br><span class="line">numerous issues over the years and recent discoveries that</span><br><span class="line">nearly all schema migration was broken in MySQL (due to some</span><br><span class="line">behavior in our migration tool), we've made the decision to</span><br><span class="line">no longer support MySQL. It is possible to bring the schema</span><br><span class="line">up to date on a MySQL machine, but Sentry's automated migrations</span><br><span class="line">will likely not work and require DBA assistance.</span><br><span class="line">Postgres is now the only supported production database."</span></span><br><span class="line">而且现在之前搭建的7.x版本清理数据慢的出奇，顾花了些时间来搭建新的sentry,</span><br><span class="line">搭建过程分享一下</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><ul>
<li>需要安装：<ul>
<li>python==2.7.5</li>
<li>Postgresql==9.2</li>
<li>sentry==8.14.1</li>
<li>redis==3.2.8</li>
</ul>
</li>
<li>系统： <ul>
<li>centos6</li>
</ul>
</li>
<li>本文重点：<ul>
<li>Postgresql安装配置</li>
<li>sentry安装配置</li>
</ul>
</li>
</ul>
<p>##　Postgresql安装配置</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">这里采用yum或者编译安装都可以，关键是配置启动，我们来说yum方式</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install postgresql</span></span><br><span class="line"><span class="comment"># yum install libpq-dev*</span></span><br><span class="line"><span class="comment"># yum install python-dev*</span></span><br><span class="line"><span class="comment"># yum install postgresql-contrib</span></span><br><span class="line"><span class="comment"># yum install postgresql-client</span></span><br><span class="line"><span class="comment"># yum install postgresql-devel</span></span><br><span class="line"><span class="comment"># yum install pgadmin3</span></span><br><span class="line"></span><br><span class="line">没有意外的话安装应该ok</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">首先不能在root下启动postgresql,所以先切到postgres(安装过程中已经创建)</span><br><span class="line"></span><br><span class="line"><span class="comment"># su postgres</span></span><br><span class="line"></span><br><span class="line">最让人恶心的是它的配置并不在etc下，而是在/var/lib/pgsql/data/(</span><br><span class="line">确定一下用户组和用户是不是postgres，不是改)</span><br><span class="line"></span><br><span class="line">$ cd /var/lib/pgsql/data/</span><br><span class="line">$ vim /var/lib/pgsql/data/pg_hba.conf</span><br><span class="line">	尤其是以下三行：</span><br><span class="line">		local   all　　　　all                 trust</span><br><span class="line">		host    all    all  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">32</span>   trust</span><br><span class="line">           host    all    all  ::<span class="number">1</span>/<span class="number">128</span>        ident</span><br><span class="line"></span><br><span class="line">   启动</span><br><span class="line"></span><br><span class="line">   $ postgres -D /var/lib/pgsql/data/</span><br></pre></td></tr></table></figure>
<h4 id="创建库"><a href="#创建库" class="headerlink" title="创建库"></a>创建库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">postgres初始后第一个用户是postgres默认下是没有密码的，但是如果不把以上</span><br><span class="line">配置配成trust登陆不了</span><br><span class="line"></span><br><span class="line">$ psql -U postgres -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">5432</span></span><br><span class="line">postgres=<span class="comment"># alter user postgres with password 'new password';</span></span><br><span class="line"></span><br><span class="line">之后更改配置文件成：</span><br><span class="line">	local   all　　　　all                 md5</span><br><span class="line">	host    all    all  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">32</span>   md5</span><br><span class="line">       host    all    all  ::<span class="number">1</span>/<span class="number">128</span>        ident</span><br><span class="line">   启动</span><br><span class="line"></span><br><span class="line">   $ postgres -D /var/lib/pgsql/data/</span><br><span class="line"></span><br><span class="line">   登陆创建库：</span><br><span class="line">   $ psql -U postgres -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">5432</span></span><br><span class="line">   postgres=<span class="comment">#　create database sentry</span></span><br></pre></td></tr></table></figure>
<h2 id="安装sentry"><a href="#安装sentry" class="headerlink" title="安装sentry"></a>安装sentry</h2><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装好python2<span class="number">.7</span>(yum或者自己编译)</span><br><span class="line">安装好redis(直接取官方下载)</span><br></pre></td></tr></table></figure>
<h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这边我们用pip的方式安装</span><br><span class="line"><span class="comment"># pip install sentry  (最新版)</span></span><br></pre></td></tr></table></figure>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim sentry.conf.py</span></span><br><span class="line"></span><br><span class="line">几个关键点：</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 连接数据库</span></span><br><span class="line">	DATABASES = &#123;</span><br><span class="line">	    <span class="string">'default'</span>: &#123;</span><br><span class="line">	        <span class="string">'ENGINE'</span>: <span class="string">'sentry.db.postgres'</span>,</span><br><span class="line">	        <span class="string">'NAME'</span>: <span class="string">'sentry'</span>,</span><br><span class="line">	        <span class="string">'USER'</span>: <span class="string">'postgres'</span>,</span><br><span class="line">	        <span class="string">'PASSWORD'</span>: <span class="string">'123456'</span>,</span><br><span class="line">	        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">	        <span class="string">'PORT'</span>: <span class="string">'5432'</span>,</span><br><span class="line">	        <span class="string">'AUTOCOMMIT'</span>: <span class="keyword">True</span>,</span><br><span class="line">	        <span class="string">'ATOMIC_REQUESTS'</span>: <span class="keyword">False</span>,</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment"># 配置SENTRY_OPTIONS</span></span><br><span class="line">	SENTRY_OPTIONS = &#123;</span><br><span class="line">	    <span class="string">'redis.clusters'</span>: &#123;</span><br><span class="line">	        <span class="string">'default'</span>: &#123;</span><br><span class="line">	            <span class="string">'hosts'</span>: &#123;</span><br><span class="line">	                <span class="number">0</span>: &#123;</span><br><span class="line">	                    <span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">	                    <span class="string">'port'</span>: <span class="number">6379</span>,</span><br><span class="line">	                    <span class="string">'password'</span>: <span class="string">''</span>,</span><br><span class="line">	                    <span class="string">'db'</span>: <span class="number">0</span></span><br><span class="line">	                &#125;</span><br><span class="line">	            &#125;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125;,</span><br><span class="line">	    <span class="string">'system.secret-key'</span>: <span class="string">'DF0d/JSUbdCx7pzq4uh/lW43svXnCGuqIfjS2krkFA7N0BIPxCgcmg=='</span>,</span><br><span class="line"></span><br><span class="line">	    <span class="string">'mail.from'</span>: <span class="string">'xx@xx.com'</span>,  <span class="comment"># 发报警邮件用</span></span><br><span class="line">	    <span class="string">'mail.host'</span>: <span class="string">'xx.xx.xx.xx'</span>,</span><br><span class="line">	    <span class="string">'mail.port'</span>: <span class="number">26</span>,</span><br><span class="line">	    <span class="string">'mail.username'</span>: <span class="string">'xx@xx.com'</span>,</span><br><span class="line">	    <span class="string">'mail.password'</span>: <span class="string">'xxxx'</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SENTRY_WEB_HOST = <span class="string">'0.0.0.0'</span></span><br><span class="line">	SENTRY_WEB_PORT = <span class="number">9000</span></span><br><span class="line">	SENTRY_WEB_OPTIONS = &#123;</span><br><span class="line">	    <span class="string">'workers'</span>: <span class="number">5</span>,  <span class="comment"># the number of web workers</span></span><br><span class="line">	    <span class="comment"># 'protocol': 'uwsgi',  # Enable uwsgi protocol instead of http</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/sentry --config=/baisong/sentry.conf.py run worker</span><br><span class="line">/usr/bin/sentry --config=/baisong/sentry.conf.py django runserver <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9000</span></span><br></pre></td></tr></table></figure>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以采用nginx代理的方式多,后端多起几个端口</span><br></pre></td></tr></table></figure>
<h2 id="关于使用"><a href="#关于使用" class="headerlink" title="关于使用"></a>关于使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">目前sentry已经搭建完毕，关于在django中如何使用，请看下边的连接</span><br></pre></td></tr></table></figure>
<p><a href="https://yunsonbai.top/2016/05/30/django-sentry/" target="_blank" rel="external">利用sentry收集django的日志</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[让自己的博客支持https]]></title>
      <url>http://yunsonbai.github.io/2017/01/12/blog-https/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">昨天把博客迁到了https下，现在博客支持https访问了。本文适合自己用机器搭建的博客。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">首先之前就已经听说从<span class="number">2017</span>年<span class="number">1</span>月份起，Chrome浏览器将会把采用HTTP协议的网站标记为“不安全”网站；另外最近自己手头的很多项目都开始往https下迁移；还有就是用谷歌浏览器看自己的博客一直提示感叹号；最后最让我郁闷的是某运营商的劫持，种种这些原因促使自己的让博客支持https访问。</span><br></pre></td></tr></table></figure>
<h2 id="https请求流程"><a href="#https请求流程" class="headerlink" title="https请求流程"></a>https请求流程</h2><p><img src="https://yunsonbai.github.io/images/https/lc.jpg" alt="Catch8D7B"></p>
<h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><ul>
<li>简单方式： 把博客部署在github上，直接就能https访问<br>  例如<a href="https://yunsonbai.github.io/">yunsonbai_github</a></li>
<li>稍微麻烦点的方式： 自己购买服务器部署上博客后，找认证机构办法签证（我采用的这个方式）<br>  例如<a href="https://yunsonbai.top" target="_blank" rel="external">yunsonbai</a><h2 id="认证机构"><a href="#认证机构" class="headerlink" title="认证机构"></a>认证机构</h2></li>
<li>收费的<ul>
<li>geotrust</li>
</ul>
</li>
<li>免费的<ul>
<li>Let’s Encrypt(本次介绍如何使用这个)</li>
</ul>
</li>
</ul>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><ul>
<li><p>创建一个临时文件ssl(存放过程中需要用到的临时文件)<br>  $ mkdir ssl<br>  $ cd ssl</p>
</li>
<li><p>创建一个 RSA 私钥用于 Let’s Encrypt 识别你的身份<br>  $ openssl genrsa 4096 &gt; account.key</p>
</li>
<li><p>生成 CSR</p>
<ul>
<li>创建 RSA 私钥<br>  $ openssl genrsa 4096 &gt; domain.key<br>  $ openssl req -new -sha256 -key domain.key -out domain.csr(基本都能看懂，都是跟地址相关的东西)</li>
</ul>
</li>
<li><p>配置nginx(针对nginx)</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">       alias /usr/local/nginx/html/.well-known/acme-challenge/;</span><br><span class="line">       try_files $uri =<span class="number">404</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">为什么要用到.well-known/acme-challenge/文件，Let<span class="string">'s Encrypt在验证网站是否归你所有的时候会访问该目录。</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>获取网站证书</p>
<ul>
<li>利用Let’s Encrypt官网提供的脚本工具</li>
<li><p>利用开源项目acme_tiny(我用的这个，不错)<br>  $ wget <a href="https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py" target="_blank" rel="external">https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py</a><br>  $ python acme_tiny.py –account-key ./account.key –csr ./domain.csr –acme-dir /usr/local/nginx/html/.well-known/acme-challenge/ &gt; ./signed.crt</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一切正常的话不会报任何错误，切记/usr/local/nginx/html/.well-known/acme-challenge/路径是你的博客相关路径</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">到目前为止拿到了证书</span><br></pre></td></tr></table></figure>
<ul>
<li>把刚才ssl文件移到你认为比较靠谱的目录下(例如 /usr/ssl)</li>
<li>配置nginx</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen <span class="number">443</span> ssl;</span><br><span class="line">	ssl_certificate /usr/ssl/signed.crt;</span><br><span class="line">	ssl_certificate_key /usr/ssl/domain.key;</span><br><span class="line">	location / &#123;</span><br><span class="line">			root   html;</span><br><span class="line">			index  index.html index.htm;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以参考<a href="http://yunsonbai.github.io/2016/06/09/nginx-https%E9%85%8D%E7%BD%AE/">nginx实现https</a></p>
<ul>
<li>将http请求转到https下</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen       <span class="number">80</span>;</span><br><span class="line">       server_name  xxx.xx;</span><br><span class="line">	location / &#123;</span><br><span class="line">		rewrite ^/(.*)$ https://xxx.xx/$<span class="number">1</span> permanent;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="需要注意的地方"><a href="#需要注意的地方" class="headerlink" title="需要注意的地方"></a>需要注意的地方</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Let<span class="string">'s Encrypt的证书只有90天有效期，所以你要美90天续签一次，最简单的方式就是利用crontab来做这个是，说白了定期执行这条python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir /usr/local/nginx/html/.well-known/acme-challenge/ &gt; ./signed.crt命令</span></span><br></pre></td></tr></table></figure>
<h2 id="大功告成"><a href="#大功告成" class="headerlink" title="大功告成"></a>大功告成</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">尝试访问一下https://yoursite.com</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[利用websocket实现聊天小应用]]></title>
      <url>http://yunsonbai.github.io/2016/12/18/%E5%88%A9%E7%94%A8websocket%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9%E5%B0%8F%E5%BA%94%E7%94%A8/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   趁着清闲研究了一下websocket，并利用python和html简单的实现了简单的聊天系统，</span><br><span class="line">希望对想要了解的有所帮助，有什么好的意见还请大家提出。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><ul>
<li>编程语言：python，html</li>
<li>实现功能： 在浏览器开启两个对话窗口并进行聊天</li>
<li>需要的第三方库：<ul>
<li>pip install websockets</li>
</ul>
</li>
<li>关于websocke:<ul>
<li>WebSocket protocol 是HTML5一种新的协议</li>
<li>实现了浏览器与服务器全双工通信</li>
</ul>
</li>
<li>我为什么要用：<ul>
<li>实现web页面的即时通讯</li>
<li>去除轮询带来的诸多缺点（这个网上一搜一大把）</li>
</ul>
</li>
</ul>
<h2 id="关于流程图"><a href="#关于流程图" class="headerlink" title="关于流程图"></a>关于流程图</h2><ul>
<li>建立连接过程<br><img src="https://yunsonbai.github.io/images/push/jl.jpg" alt="Catch8D7B"></li>
<li>发信过程<br><img src="https://yunsonbai.github.io/images/push/fx.jpg" alt="Catch8D7B"></li>
</ul>
<h2 id="后端代码"><a href="#后端代码" class="headerlink" title="后端代码"></a>后端代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># codind=utf-8</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">ALLSOKETS = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_connection</span><span class="params">(ws_id, ws)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> ALLSOKETS</span><br><span class="line">	ALLSOKETS[ws_id] = ws</span><br><span class="line">	print(ALLSOKETS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_handle</span><span class="params">(ws_id)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> ALLSOKETS.get(ws_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(websocket, path)</span>:</span></span><br><span class="line">	<span class="comment"># print(path)</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		message = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">		message = json.loads(message)</span><br><span class="line">		login = message.get(<span class="string">'login'</span>)</span><br><span class="line">		<span class="keyword">if</span> login:</span><br><span class="line">			add_connection(message[<span class="string">'user_id'</span>], websocket)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			ws = filter_handle(message[<span class="string">'to_user_id'</span>])</span><br><span class="line">			<span class="keyword">if</span> ws:</span><br><span class="line">				<span class="keyword">await</span> ws.send(message[<span class="string">'msg'</span>])</span><br><span class="line">		print(<span class="string">'recv:'</span>, message)</span><br><span class="line">		print(time.time())</span><br><span class="line"></span><br><span class="line">start_server = websockets.serve(</span><br><span class="line">	handler, <span class="string">'localhost'</span>, <span class="number">8765</span>, klass=websockets.WebSocketServerProtocol)</span><br><span class="line">asyncio.get_event_loop().run_until_complete(start_server)</span><br><span class="line">asyncio.get_event_loop().run_forever()</span><br></pre></td></tr></table></figure>
<h2 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h2><ul>
<li>client1</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">	&lt;title&gt;WebSocket1&lt;/title&gt;</span><br><span class="line">	&lt;style&gt;</span><br><span class="line">		html,body&#123;font:normal 0.9em arial,helvetica;&#125;</span><br><span class="line">		#log &#123;width:440px; height:200px; border:1px solid #7F9DB9; overflow:auto;&#125;</span><br><span class="line">		#msg &#123;width:330px;&#125;</span><br><span class="line">	&lt;/style&gt;</span><br><span class="line">	&lt;script&gt;</span><br><span class="line">		var socket;</span><br><span class="line">		function init()&#123;</span><br><span class="line">			var host = &quot;ws://127.0.0.1:8765/&quot;;</span><br><span class="line">			socket = new WebSocket(host);</span><br><span class="line">			try&#123;</span><br><span class="line">				socket.onopen    = function(msg)&#123; ; &#125;;</span><br><span class="line">				socket.onmessage = function(msg)&#123; log(msg.data); &#125;;</span><br><span class="line">			&#125;</span><br><span class="line">			catch(ex)&#123;</span><br><span class="line">				socket.onclose   = function(msg)&#123; log(&quot;Lose Connection!&quot;); &#125;;</span><br><span class="line">				log(ex); </span><br><span class="line">			&#125;</span><br><span class="line">			$(&quot;msg&quot;).focus();</span><br><span class="line">		&#125;</span><br><span class="line">		function send()&#123;</span><br><span class="line">			var txt,msg;</span><br><span class="line">			txt = $(&quot;msg&quot;);</span><br><span class="line">			msg = txt.value;</span><br><span class="line">			if(!msg)&#123; </span><br><span class="line">				alert(&quot;Message can not be empty&quot;); </span><br><span class="line">				return; </span><br><span class="line">			&#125;</span><br><span class="line">			log(msg)</span><br><span class="line">			msg = &apos;&#123;&quot;to_user_id&quot;: &quot;WebSocket2&quot;, &quot;msg&quot;:&quot;&apos; + msg + &apos;&quot;&#125;&apos;</span><br><span class="line">			txt.value=&quot;&quot;;</span><br><span class="line">			txt.focus();</span><br><span class="line">			try&#123; </span><br><span class="line">				socket.send(msg); </span><br><span class="line">			&#125; </span><br><span class="line">			catch(ex)&#123; </span><br><span class="line">				log(ex); </span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		function login()&#123;</span><br><span class="line">			msg = &apos;&#123;&quot;user_id&quot;: &quot;WebSocket1&quot;, &quot;login&quot;: &quot;1&quot;&#125;&apos;</span><br><span class="line">			socket.send(msg); </span><br><span class="line">		&#125;         </span><br><span class="line"></span><br><span class="line">		function $(id)&#123; </span><br><span class="line">			var id = document.getElementById(id);</span><br><span class="line">			return id;</span><br><span class="line">		&#125;</span><br><span class="line">		function log(msg)&#123; </span><br><span class="line">			$(&quot;log&quot;).innerHTML+=&quot;&lt;br&gt;&quot;+msg; </span><br><span class="line">		&#125;</span><br><span class="line">		function onkey(event)&#123; </span><br><span class="line">			if(event.keyCode==13)&#123; </span><br><span class="line">				send(); </span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line">	&lt;/script&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body onload=&quot;init()&quot;&gt;</span><br><span class="line">		&lt;h3&gt;WebSocket1&lt;/h3&gt;</span><br><span class="line">		&lt;br&gt;&lt;br&gt;</span><br><span class="line">		&lt;button onclick=&quot;login()&quot;&gt;login&lt;/button&gt;</span><br><span class="line">		&lt;div id=&quot;log&quot;&gt;&lt;/div&gt;</span><br><span class="line">		&lt;input id=&quot;msg&quot; type=&quot;textbox&quot; onkeypress=&quot;onkey(event)&quot;/&gt;</span><br><span class="line">		&lt;button onclick=&quot;send()&quot;&gt;发送&lt;/button&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>client2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">与client1差不多只是改下边两处即可</span><br><span class="line">function send()&#123;</span><br><span class="line">	var txt,msg;</span><br><span class="line">	txt = $(&quot;msg&quot;);</span><br><span class="line">	msg = txt.value;</span><br><span class="line">	if(!msg)&#123;</span><br><span class="line">		alert(&quot;Message can not be empty&quot;); </span><br><span class="line">		return; </span><br><span class="line">	&#125;</span><br><span class="line">	log(msg)</span><br><span class="line">	msg = &apos;&#123;&quot;to_user_id&quot;: &quot;WebSocket1&quot;, &quot;msg&quot;:&quot;&apos; + msg + &apos;&quot;&#125;&apos;</span><br><span class="line">	txt.value=&quot;&quot;;</span><br><span class="line">	txt.focus();</span><br><span class="line">	try&#123; </span><br><span class="line">		socket.send(msg); </span><br><span class="line">	&#125; </span><br><span class="line">	catch(ex)&#123; </span><br><span class="line">		log(ex); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">function login()&#123;</span><br><span class="line">	msg = &apos;&#123;&quot;user_id&quot;: &quot;WebSocket2&quot;, &quot;login&quot;: &quot;1&quot;&#125;&apos;</span><br><span class="line">	socket.send(msg); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h2><ul>
<li>开启后端代码 python server.py</li>
<li>打开浏览器，访问html文件，分别打开client1.html和client2.html</li>
<li>相互发信</li>
</ul>
<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><ul>
<li>clent1<br><img src="https://yunsonbai.github.io/images/push/c1.jpg" alt="Catch8D7B"></li>
<li>clent2<br><img src="https://yunsonbai.github.io/images/push/c2.jpg" alt="Catch8D7B"></li>
</ul>
<h2 id="还需要优化的地方"><a href="#还需要优化的地方" class="headerlink" title="还需要优化的地方"></a>还需要优化的地方</h2><ul>
<li>添加鉴权<ul>
<li>header中添加token</li>
<li>或者通过参数等等</li>
</ul>
</li>
<li>添加nginx代理, 网上有很多说明，记得以下几个参数<ul>
<li>proxy_http_version 1.1</li>
<li>proxy_set_header Upgrade $http_upgrade</li>
<li>proxy_set_header Connection “upgrade”    </li>
</ul>
</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[apns2 based on http2]]></title>
      <url>http://yunsonbai.github.io/2016/10/20/apns2/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">最近项目中需要用到apns，做了一下apns的功课，旧APNs有点反人类，而基于 HTTP/2 的</span><br><span class="line">全新APNs 协议则有巨大的优势，于是自己封装了一个基于http2协议的apns。</span><br><span class="line">欢迎大家提出修改意见。</span><br></pre></td></tr></table></figure>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a href="https://github.com/yunsonbai/apns2" target="_blank" rel="external">apns2</a></p>
<a id="more"></a>
<h2 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h2><ul>
<li>应用：iso消息推送</li>
<li>版本：0.2</li>
<li>主要功能和特点:<ul>
<li>基于http2</li>
<li>支持批量发送</li>
</ul>
</li>
<li>安装<ul>
<li>git clone git@github.com:yunsonbai/apns2.git</li>
<li>python setup.py install</li>
</ul>
</li>
</ul>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> apns2.client <span class="keyword">import</span> APNsClient</span><br><span class="line"><span class="keyword">from</span> apns2.payload <span class="keyword">import</span> Payload</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">()</span>:</span></span><br><span class="line">    token_hexs = [</span><br><span class="line">        <span class="string">'f9dcb885edbfcddsdaf64960bed56b19c362b3c617565126b085af2c8829467a'</span>,</span><br><span class="line">        <span class="string">'9dc9662fa9dsd390fc6b3d3ec637a764867241f516d847b54d24ce7e37963b6e'</span>,</span><br><span class="line">        <span class="string">'d52c31a293aa79c61222626b0d025866ssssa4d0c79a2b2bf729cd48c61f14a2'</span>,</span><br><span class="line">        <span class="string">'8c51ed081211d19d90f4b34b403c39f5ceeeeec368cfd9277812a7af778fbf5f'</span>,</span><br><span class="line">        <span class="string">'3df3c6bc4a98c38d5d13cbb932f4969f5f0efhhha8e4cd32270777f273dc0e41'</span>,</span><br><span class="line">        <span class="string">'a25fbf0b5f84632406f33a78398138c87d13iiiiiiiiiiic466c11be9de22011'</span>,</span><br><span class="line">        <span class="string">'3df3c6bc4a98c38d5d13cbb932f4969f5f0efyyyy8e4cd32270777f273dc0e41'</span>,</span><br><span class="line">        <span class="string">'aef8a3d0b6d38807ad8ab485665d36edc305a9793jjj269214bcd3357f60e07a'</span>]</span><br><span class="line">    print(len(token_hexs))</span><br><span class="line">    payload = Payload(alert=<span class="string">"Hello World!"</span>, sound=<span class="string">"default"</span>)</span><br><span class="line">    <span class="comment"># custom = &#123;</span></span><br><span class="line">    <span class="comment">#     'custom': &#123;</span></span><br><span class="line">    <span class="comment">#         'type': 1</span></span><br><span class="line">    <span class="comment">#     &#125;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">    <span class="comment"># payload = Payload(custom=custom, content_available=True)</span></span><br><span class="line">    client = APNsClient(</span><br><span class="line">        <span class="string">'Dev_Cer-key.pem'</span>,</span><br><span class="line">        <span class="comment"># 'Cer_Key.pem',</span></span><br><span class="line">        use_sandbox=<span class="keyword">True</span>,</span><br><span class="line">        use_alternative_port=<span class="keyword">False</span>)</span><br><span class="line">    response = client.send_notification_multiple(token_hexs, payload)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response_handler</span><span class="params">(response)</span>:</span></span><br><span class="line">	<span class="comment"># do something: delete badtoken and so on</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    response = push()</span><br><span class="line">	response_handler(response)</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[yuntool]]></title>
      <url>http://yunsonbai.github.io/2016/09/29/yuntool/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    工作中总会遇到运营人员提出统计某个指标的需求，诸如需要绘图并邮件发送等需求，工作之余总结了一个工具包，包括</span><br><span class="line">数据库查询（就像使用django那样快速方便的查询）， 图表绘制，邮件发送，其他功能还在持续更新中。这些是我工作遇到</span><br><span class="line">的，有觉得不合适的地方欢迎提出修改意见。</span><br></pre></td></tr></table></figure>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a href="https://github.com/yunsonbai/yuntool" target="_blank" rel="external">yuntool</a></p>
<a id="more"></a>
<h2 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h2><ul>
<li>应用：运营数据统计；快熟查询数据库异常数据；快速数据进行增删改查</li>
<li>版本：0.4</li>
<li>安装：<ul>
<li>git clone git@github.com:yunsonbai/yuntool.git</li>
<li>python setup.py install</li>
</ul>
</li>
<li>主要功能和特点:<ul>
<li>采用orm方式操作数据库</li>
<li>支持画图<ul>
<li>曲线图</li>
<li>柱形图</li>
</ul>
</li>
<li>制表excel</li>
<li>支持邮件发送<ul>
<li>纯文字</li>
<li>图加文字</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="部分例子"><a href="#部分例子" class="headerlink" title="部分例子"></a>部分例子</h2><h3 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> yuntool.db.field <span class="keyword">import</span> CharField</span><br><span class="line"><span class="keyword">from</span> yuntool.db.models <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">from</span> yuntool.chart.sheet <span class="keyword">import</span> create_sheet</span><br><span class="line"><span class="keyword">from</span> yuntool.chart.plot <span class="keyword">import</span> draw_curve, draw_bar</span><br><span class="line"><span class="keyword">from</span> yuntool.email.smtp <span class="keyword">import</span> send_mail</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_get_orm</span><span class="params">()</span>:</span></span><br><span class="line">    select_term = &#123;</span><br><span class="line">        <span class="string">'label__une'</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="comment"># 'type__eq': 100,</span></span><br><span class="line">        <span class="comment"># 'send_time__gte': '2015-09-25 00:00:00',</span></span><br><span class="line">        <span class="comment"># 'send_time__gte': send_time_gte + ' 00:00:00',</span></span><br><span class="line">        <span class="comment"># 'send_time__lte': send_time_gte + ' 23:59:59'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># print '---------------&#123;0&#125;-------------------'.format(send_time_gte)</span></span><br><span class="line">    queryset = TestOrm.objects.filter(**select_term)</span><br><span class="line">    count = queryset.count()</span><br><span class="line">    res = queryset.data()</span><br><span class="line">    print(count)</span><br><span class="line">    data = []</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        <span class="comment"># only print the fields that are defined in TestOrm</span></span><br><span class="line">        data.append([r.title, r.label])</span><br><span class="line">        print(r.title)</span><br><span class="line">    print(<span class="string">'----------------------'</span>)</span><br><span class="line">    res_limit = queryset.limit(<span class="number">1</span>, <span class="number">2</span>).data()</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res_limit:</span><br><span class="line">        <span class="comment"># only print the fields that are defined in TestOrm</span></span><br><span class="line">        print(r.title)</span><br><span class="line">    <span class="comment"># ---------------------</span></span><br><span class="line">    print(<span class="string">'------------------'</span>)</span><br><span class="line">    res = TestOrm.objects.filter(label=<span class="number">1</span>, title=<span class="string">'test10'</span>).data()</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        <span class="comment"># only print the fields that are defined in TestOrm</span></span><br><span class="line">        data.append([r.title, r.label])</span><br><span class="line">        print(r.title)</span><br><span class="line"></span><br><span class="line">    title = <span class="string">'test_sheet'</span></span><br><span class="line">    hearder_list = [<span class="string">'title'</span>, <span class="string">'label'</span>]</span><br><span class="line">    f = create_sheet(title, hearder_list, data)</span><br><span class="line">    new_f = open(<span class="string">'text.xlsx'</span>, <span class="string">'wb'</span>)</span><br><span class="line">    new_f.write(f.read())</span><br><span class="line">    new_f.close()</span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>
<h3 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_update_orm</span><span class="params">()</span>:</span></span><br><span class="line">    update_data = &#123;</span><br><span class="line">        <span class="string">'title'</span>: <span class="string">'hello yunsonbai'</span>,</span><br><span class="line">        <span class="string">'label'</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = TestOrm.objects.filter(id__in=[<span class="number">1</span>, <span class="number">2</span>]).data()</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        r.update(**update_data)</span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    res = TestOrm.objects.filter(id=<span class="number">3</span>).first().data()</span><br><span class="line">    res.update(**update_data)</span><br></pre></td></tr></table></figure>
<h3 id="绘图"><a href="#绘图" class="headerlink" title="绘图"></a>绘图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_bar</span><span class="params">()</span>:</span></span><br><span class="line">    x = [</span><br><span class="line">        [<span class="string">'2016-06-28'</span>, <span class="string">'2016-06-29'</span>, <span class="string">'2016-06-30'</span>,</span><br><span class="line">         <span class="string">'2016-07-01'</span>, <span class="string">'2016-07-02'</span>, <span class="string">'2016-07-03'</span>, <span class="string">'2016-07-04'</span></span><br><span class="line">         ],</span><br><span class="line">        [<span class="string">'2016-06-28'</span>, <span class="string">'2016-06-29'</span>, <span class="string">'2016-06-30'</span>, <span class="string">'2016-07-01'</span>,</span><br><span class="line">         <span class="string">'2016-07-02'</span>, <span class="string">'2016-07-03'</span>, <span class="string">'2016-07-04'</span>]]</span><br><span class="line">    y = [</span><br><span class="line">        [<span class="number">270</span>, <span class="number">279</span>, <span class="number">288</span>, <span class="number">273</span>, <span class="number">248</span>, <span class="number">232</span>, <span class="number">293</span>],</span><br><span class="line">        [<span class="number">2482</span>, <span class="number">1890</span>, <span class="number">2359</span>, <span class="number">7506</span>, <span class="number">14561</span>, <span class="number">14741</span>, <span class="number">16191</span>]]</span><br><span class="line">    picture = draw_bar(</span><br><span class="line">        x, y, xlabel=[<span class="string">'date'</span>, <span class="string">'date'</span>], ylabel=[<span class="string">'num'</span>, <span class="string">'num1'</span>], merge=<span class="keyword">True</span>)</span><br><span class="line">    new_f = open(<span class="string">'text_merge.png'</span>, <span class="string">'wb'</span>)</span><br><span class="line">    new_f.write(picture.read())</span><br><span class="line">    new_f.close()</span><br><span class="line">    picture.seek(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> picture</span><br></pre></td></tr></table></figure>
<h4 id="图片展示"><a href="#图片展示" class="headerlink" title="图片展示"></a>图片展示</h4><ul>
<li>柱形图<img src="https://yunsonbai.github.io/images/yuntool/text.png"></li>
<li>条形图<img src="https://yunsonbai.github.io/images/yuntool/text_curve.png">
</li>
</ul>
<h3 id="邮件发送"><a href="#邮件发送" class="headerlink" title="邮件发送"></a>邮件发送</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_email</span><span class="params">(picture)</span>:</span></span><br><span class="line">    <span class="comment"># test email</span></span><br><span class="line">    from_user = <span class="string">'yunsonbai@sohu.com'</span></span><br><span class="line">    from_user_passwd = <span class="string">'xxxxxx'</span></span><br><span class="line">    mail_server = <span class="string">'192.168.95.xx'</span></span><br><span class="line">    mail_server_port = <span class="string">'xx'</span></span><br><span class="line">    to_users = [<span class="string">'1942893504@qq.com'</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        subject = <span class="string">'关于test'</span>.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        subject = <span class="string">'关于test'</span></span><br><span class="line">    content = <span class="string">'请回复'</span></span><br><span class="line">    send_mail(</span><br><span class="line">        from_user, from_user_passwd, to_users,</span><br><span class="line">        subject, content, mail_server,</span><br><span class="line">        mail_server_port=mail_server_port,</span><br><span class="line">        picture=picture.getvalue())</span><br><span class="line">    picture.close()</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[nginx图片鉴权]]></title>
      <url>http://yunsonbai.github.io/2016/08/09/nginx%E5%9B%BE%E7%89%87%E9%89%B4%E6%9D%83/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   在开发过程中总离不开用户系统，有了用户系统就免不了有些资源需要和用户关联上,</span><br><span class="line">所以就无法避免的有了需要资源私有化的问题，比如某张图片或某个字体只能允许所</span><br><span class="line">有者才能访问，该怎么做鉴权防止其他用户访问，昨天试了一下nginx的internal</span><br><span class="line">相信应该能满足这样的需求。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">隐藏图片的原地址，并能实现鉴权只有拥有者才能访问。</span><br></pre></td></tr></table></figure>
<h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">系统：ubuntu</span><br><span class="line">app：django</span><br><span class="line">web：nginx</span><br></pre></td></tr></table></figure>
<h2 id="流程说明"><a href="#流程说明" class="headerlink" title="流程说明"></a>流程说明</h2><p><img src="/images/nginx/nginx_django图片鉴权.png" alt="Catch8D7B"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="nginx设置"><a href="#nginx设置" class="headerlink" title="nginx设置"></a>nginx设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name www.example.com;</span><br><span class="line">       client_max_body_size 150m;</span><br><span class="line">       access_<span class="built_in">log</span> /home/baisong/project/yunsonbai/<span class="built_in">log</span>/nginx/test.log main;</span><br><span class="line">       error_<span class="built_in">log</span> /home/baisong/project/yunsonbai/<span class="built_in">log</span>/nginx/<span class="built_in">test</span>_error.log;</span><br><span class="line">       location / &#123;</span><br><span class="line">           proxy_pass    http://127.0.0.1:8000/;</span><br><span class="line">       &#125;</span><br><span class="line">       location /private/ &#123;</span><br><span class="line">           internal;</span><br><span class="line">           <span class="comment"># http://www.yunsonbai.top/images/avtar.jpg</span></span><br><span class="line">           proxy_pass    http://www.yunsonbai.top/;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="hosts配置"><a href="#hosts配置" class="headerlink" title="hosts配置"></a>hosts配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">怎么配置就不说了，配置这项就是为了测试方便</span><br></pre></td></tr></table></figure>
<h3 id="django程序-views-py"><a href="#django程序-views-py" class="headerlink" title="django程序(views.py)"></a>django程序(views.py)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class Test(APIView):</span><br><span class="line"></span><br><span class="line">   <span class="string">''</span><span class="string">'</span><br><span class="line">   test</span><br><span class="line">   '</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line">   def get(self, request):</span><br><span class="line">       user_id = request.query_params.get(<span class="string">'user_id'</span>, None)</span><br><span class="line">       <span class="keyword">if</span> user_auth(user_id):</span><br><span class="line">		<span class="comment"># 这里写相对路径</span></span><br><span class="line">           url = <span class="string">'/private/images/avtar.jpg'</span></span><br><span class="line">           response = HttpResponse()</span><br><span class="line">           response[<span class="string">'Content-Type'</span>] = <span class="string">""</span></span><br><span class="line">           response[<span class="string">'X-Accel-Redirect'</span>] = url</span><br><span class="line">           <span class="built_in">return</span> response</span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           <span class="built_in">return</span> HttpResponseForbidden()</span><br></pre></td></tr></table></figure>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><h3 id="用户合法"><a href="#用户合法" class="headerlink" title="用户合法"></a>用户合法</h3><p><img src="/images/nginx/合法.jpg" alt="Catch8D7B"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以看到隐藏了真正的资源链接</span><br></pre></td></tr></table></figure></p>
<h3 id="用户不合法"><a href="#用户不合法" class="headerlink" title="用户不合法"></a>用户不合法</h3><p><img src="/images/nginx/不合法.jpg" alt="Catch8D7B"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以看到直接返回403,并没有暴露资源地址</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该方法适用除了图片私有化其他资源也可以采用，例如表情等，当然不是唯一办法，文章有不</span><br><span class="line">合适的地方可以一起讨论。</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[rest_framework父表查子表]]></title>
      <url>http://yunsonbai.github.io/2016/07/26/rest-framework%E7%88%B6%E8%A1%A8%E6%9F%A5%E5%AD%90%E8%A1%A8/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">表A的外键是B表，想在django接口中查询B表把A表的信息携带出来，</span><br><span class="line">rest_framework可以分方便的实现,另外django配合上rest_framework，</span><br><span class="line">编写API将是你如鱼得水，写起来非常方便。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">显示对应Duoshuod的评论的user_id和评论内容, 统计评论总数</span><br></pre></td></tr></table></figure>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="model设计"><a href="#model设计" class="headerlink" title="model设计"></a>model设计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Duoshuo(models.Model):</span><br><span class="line">    create_time = models.DateTimeField(auto_now_add=True)</span><br><span class="line">    text = models.CharField(max_length=128)</span><br><span class="line"></span><br><span class="line">    def __unicode__(self):</span><br><span class="line">        <span class="built_in">return</span> str(self.id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class DuoshuoComment(models.Model):</span><br><span class="line">    feed = models.ForeignKey(Duoshuo, related_name=<span class="string">'comment_duoshuo'</span>)</span><br><span class="line">    user_id = models.CharField(max_length=255)</span><br><span class="line">    content = models.CharField(max_length=255)</span><br><span class="line"></span><br><span class="line">    def __unicode__(self):</span><br><span class="line">        <span class="built_in">return</span> self.content</span><br></pre></td></tr></table></figure>
<h3 id="serializers-py"><a href="#serializers-py" class="headerlink" title="serializers.py"></a>serializers.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line">from app.modele import Duoshuo, DuoshuoComment</span><br><span class="line"></span><br><span class="line">class FeedSerializer(serializers.ModelSerializer):</span><br><span class="line"></span><br><span class="line">    duoshuo_comment = serializers.PrimaryKeyRelatedField(<span class="string">'</span><br><span class="line">                    source='</span>comment_duoshuo<span class="string">',</span><br><span class="line">                    many=True,</span><br><span class="line">                    read_only=True)</span><br><span class="line">    comment_num = serializers.SerializerMethodField(</span><br><span class="line">                    '</span>comment_total<span class="string">')</span><br><span class="line">    class Meta:</span><br><span class="line">        model = Duoshuo</span><br><span class="line">        fields = ('</span>id<span class="string">', '</span>duoshuo_comment<span class="string">', '</span>comment_num<span class="string">')</span><br><span class="line"></span><br><span class="line">    def comment_total(self, obj):</span><br><span class="line">         total = DuoshuoComment.objects.filter(feed=obj).count()</span><br><span class="line">        return total</span></span><br></pre></td></tr></table></figure>
<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在serializers.py还可以写相关的函数来整理查询后的结果，可查看官网。</span><br><span class="line">rest_framework在协助django编写api方面非常方便，有兴趣的可以在官方查询</span><br><span class="line">如何在django中使用rest_framework。</span><br></pre></td></tr></table></figure>
<p><a href="http://www.django-rest-framework.org/" target="_blank" rel="external">rest_framework官网</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在django中只使用celery]]></title>
      <url>http://yunsonbai.github.io/2016/07/18/django%E4%BD%BF%E7%94%A8celery/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">前段时间分享了一篇在django中使用djcelery来完成异步任务，使用的小伙伴会发现djcelery会在mysql创建很多表，</span><br><span class="line">如果你不使用mysql作为BROKER的话,数据显得很脏，另外如果你用了mysql作为BROKER又会带来性能问题，毕竟数据库</span><br><span class="line">的读写速度不如缓存。接下来就分享一下如何在django中不使用djcelery，而是纯粹的使用celery来实现异步任务。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="先看一下目录结构"><a href="#先看一下目录结构" class="headerlink" title="先看一下目录结构"></a>先看一下目录结构</h2><img src="https://yunsonbai.github.io/images/celery/celery_django.png">
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意看celery.py 和tasks.py两个文件，这个是celery官方给出的例子</span><br></pre></td></tr></table></figure>
<h2 id="代码示例及启动"><a href="#代码示例及启动" class="headerlink" title="代码示例及启动"></a>代码示例及启动</h2><h3 id="celery-py"><a href="#celery-py" class="headerlink" title="celery.py"></a>celery.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from __future__ import absolute_import</span><br><span class="line">   import os</span><br><span class="line"></span><br><span class="line">   from celery import Celery</span><br><span class="line"></span><br><span class="line">   <span class="comment"># set the default Django settings module for the 'celery' program.</span></span><br><span class="line">   os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'proj.settings'</span>)</span><br><span class="line"></span><br><span class="line">   from django.conf import settings  <span class="comment"># noqa</span></span><br><span class="line"></span><br><span class="line">   app = Celery(<span class="string">'proj'</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># Using a string here means the worker will not have to</span></span><br><span class="line">   <span class="comment"># pickle the object when using Windows.</span></span><br><span class="line">   app.config_from_object(<span class="string">'django.conf:settings'</span>)</span><br><span class="line">   app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)</span><br><span class="line"></span><br><span class="line">   @app.task(<span class="built_in">bind</span>=True)</span><br><span class="line">   def debug_task(self):</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">'Request: &#123;0!r&#125;'</span>.format(self.request))</span><br></pre></td></tr></table></figure>
<h3 id="init-py"><a href="#init-py" class="headerlink" title="init.py"></a><strong>init</strong>.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在与celery.py同级的__init__.py文件中加入(这也都是官方给出的)</span><br><span class="line">   	from __future__ import absolute_import</span><br><span class="line">       <span class="comment"># This will make sure the app is always imported when</span></span><br><span class="line">       <span class="comment"># Django starts so that shared_task will use this app.</span></span><br><span class="line">       from .celery import app as celery_app  <span class="comment"># noqa</span></span><br></pre></td></tr></table></figure>
<h3 id="tasks-py"><a href="#tasks-py" class="headerlink" title="tasks.py"></a>tasks.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">（这是自己造的）</span><br><span class="line">from __future__ import absolute_import</span><br><span class="line">   from proj import celery_app</span><br><span class="line">   import time</span><br><span class="line"></span><br><span class="line">   @celery_app.task(<span class="built_in">bind</span>=True)</span><br><span class="line">   def mul(*args, **kwargs):</span><br><span class="line">       f = open(<span class="string">'/home/baisong/a.txt'</span>, <span class="string">'a+'</span>)</span><br><span class="line">       f.write(str(time.time()))</span><br><span class="line">       f.write(<span class="string">'/n'</span>)</span><br><span class="line">       f.close()</span><br></pre></td></tr></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beat:</span><br><span class="line">   	celery -A proj beat <span class="_">-l</span> info</span><br><span class="line">   worker:</span><br><span class="line">   	celery -A proj worker <span class="_">-l</span> info</span><br></pre></td></tr></table></figure>
<h2 id="提问"><a href="#提问" class="headerlink" title="提问"></a>提问</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">前边几乎全是官方给出的，下边是有些人会遇到的，多配置文件怎么</span><br><span class="line">   办， 可以看看下边的目录结构</span><br></pre></td></tr></table></figure>
<img src="https://yunsonbai.github.io/images/celery/moresettings.jpg">
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="重写celery-py"><a href="#重写celery-py" class="headerlink" title="重写celery.py"></a>重写celery.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from __future__ import absolute_import</span><br><span class="line">   import os</span><br><span class="line">   from celery import Celery</span><br><span class="line">   import sys</span><br><span class="line">   from django.conf import settings</span><br><span class="line">   app_name = <span class="string">'proj'</span></span><br><span class="line">   defauke_config = <span class="string">'proj.settings'</span></span><br><span class="line">   try:</span><br><span class="line">       defauke_config = sys.argv[-1].split(<span class="string">'--config='</span>)[1]</span><br><span class="line">   except:</span><br><span class="line">       pass</span><br><span class="line">   <span class="comment"># set the default Django settings module for the 'celery' program.</span></span><br><span class="line">   os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, str(defauke_config))</span><br><span class="line"></span><br><span class="line">   app = Celery(app_name)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># Using a string here means the worker will not have to</span></span><br><span class="line">   <span class="comment"># pickle the object when using Windows.</span></span><br><span class="line">   app.config_from_object(<span class="string">'django.conf:settings'</span>)</span><br><span class="line">   app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)</span><br></pre></td></tr></table></figure>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">celery -A proj beat <span class="_">-l</span> info --config=proj.settings.settings1</span><br><span class="line">   celery -A proj worker <span class="_">-l</span> info --config=proj.settings.settings1</span><br></pre></td></tr></table></figure>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p><a href="https://www.yunsonbai.top/2016/07/12/celery/" target="_blank" rel="external">celery 异步任务</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[celery 异步任务]]></title>
      <url>http://yunsonbai.github.io/2016/07/12/celery/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在开发的过程中，总会遇到异步完成某个操作的需求，选择会很多，说一下在python编程过程中如何实现异步任务，让你优雅的完成</span><br><span class="line">任务，优化自己的应用。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="初始celery"><a href="#初始celery" class="headerlink" title="初始celery"></a>初始celery</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">任务调度利器,是基于Python开发的分布式任务队列。它支持使用任务队列的方式在分布的机器／进程／线程上执行任务调度。</span><br></pre></td></tr></table></figure>
<h2 id="单独使用celery"><a href="#单独使用celery" class="headerlink" title="单独使用celery"></a>单独使用celery</h2><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">定时往文件中写入和在程序中异步添加任务往文件中写入</span><br></pre></td></tr></table></figure>
<h3 id="编写tasks"><a href="#编写tasks" class="headerlink" title="编写tasks"></a>编写tasks</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line">   from celery import Celery</span><br><span class="line"></span><br><span class="line">   celery = Celery(<span class="string">'tasks'</span>, broker=<span class="string">'redis://localhost:6379/0'</span>)</span><br><span class="line"></span><br><span class="line">   @celery.task</span><br><span class="line">   def <span class="built_in">test</span>(sss):</span><br><span class="line">       f = open(<span class="string">'/yunsonbai/apps/asyn_task/celery/a.txt'</span>,<span class="string">'a+'</span>)</span><br><span class="line">       f.write(sss)</span><br><span class="line">       f.close()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">       sendmail(<span class="string">'bas'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="celeryconfig配置文件"><a href="#celeryconfig配置文件" class="headerlink" title="celeryconfig配置文件"></a>celeryconfig配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">这个比较重要，关系到启动</span><br><span class="line">   from datetime import timedelta</span><br><span class="line"></span><br><span class="line">   BROKER_URL = <span class="string">'redis://127.0.0.1:6379/0'</span></span><br><span class="line">   CELERY_RESULT_BACKEND = <span class="string">'redis://127.0.0.1:6379/1'</span></span><br><span class="line"></span><br><span class="line">   CELERY_TASK_SERIALIZER = <span class="string">'json'</span></span><br><span class="line">   CELERY_RESULT_SERIALIZER = <span class="string">'json'</span></span><br><span class="line">   CELERY_ENABLE_UTC = False</span><br><span class="line">   CELERY_TIMEZONE = <span class="string">'Asia/Shanghai'</span></span><br><span class="line">   CELERY_IMPORTS = (<span class="string">"tasks"</span>,)</span><br><span class="line">   <span class="comment"># 定时执行</span></span><br><span class="line">   <span class="comment"># CELERYBEAT_SCHEDULE = &#123;</span></span><br><span class="line">   <span class="comment">#     'runs-every-30-seconds': &#123;</span></span><br><span class="line">   <span class="comment">#         'task': 'tasks.sendmail',</span></span><br><span class="line">   <span class="comment">#         'schedule': timedelta(seconds=30),</span></span><br><span class="line">   <span class="comment">#         'args': ('baisong',),</span></span><br><span class="line">   <span class="comment">#     &#125;,</span></span><br><span class="line">   <span class="comment"># &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="note"><a href="#note" class="headerlink" title="note"></a>note</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果使用redis，建议使用CELERY_QUEUES和CELERY_ROUTES两个配置项，可以让你使不用应用的任务区分开，不然如果用同一个</span><br><span class="line">   redis库存储BROKER，多个worker之间会发生干扰。另外就是让tasks和celeryconfig在同一个目录下。</span><br></pre></td></tr></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">celery worker --loglevel=debug --config=celeryconfig  负责执行任务</span><br><span class="line">   celery beat --loglevel=info --config=celeryconfig 负责添加任务（针对定时任务，如果没有可以不启动）</span><br></pre></td></tr></table></figure>
<h3 id="如何在程序中添加任务"><a href="#如何在程序中添加任务" class="headerlink" title="如何在程序中添加任务"></a>如何在程序中添加任务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from tasks import <span class="built_in">test</span></span><br><span class="line">   result = sendmail.apply_async(args =(<span class="string">'yusonbaio'</span>,))</span><br><span class="line">   <span class="comment"># print result</span></span><br></pre></td></tr></table></figure>
<h2 id="在django中使用celery"><a href="#在django中使用celery" class="headerlink" title="在django中使用celery"></a>在django中使用celery</h2><h3 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">同上</span><br></pre></td></tr></table></figure>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">能方便的调用model、settings等，方便数据库操作。</span><br></pre></td></tr></table></figure>
<h3 id="tasks"><a href="#tasks" class="headerlink" title="tasks"></a>tasks</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line">   from celery import app</span><br><span class="line"></span><br><span class="line">   @app.task</span><br><span class="line">   def <span class="built_in">test</span>(sss):</span><br><span class="line">       f = open(<span class="string">'/yunsonbai/apps/asyn_task/celery/a.txt'</span>,<span class="string">'a+'</span>)</span><br><span class="line">       f.write(sss)</span><br><span class="line">       f.close()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">       <span class="built_in">test</span>(<span class="string">'bas'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">把上边的配置文件复制到settings中，同时在INSTALLED_APPS加入djcelery，记</span><br><span class="line">   得安装djcelery</span><br></pre></td></tr></table></figure>
<h3 id="添加celety-py文件"><a href="#添加celety-py文件" class="headerlink" title="添加celety.py文件"></a>添加celety.py文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">在与app同级目录下添加celety.py文件，如下：</span><br><span class="line">   	from __future__ import absolute_import</span><br><span class="line">       import os</span><br><span class="line">       from celery import Celery</span><br><span class="line">       from django.conf import settings</span><br><span class="line"></span><br><span class="line">       os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'app.settings'</span>)</span><br><span class="line">       app = Celery(<span class="string">'app'</span>)</span><br><span class="line"></span><br><span class="line">       app.config_from_object(<span class="string">'django.conf:settings'</span>)</span><br><span class="line">       app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)</span><br></pre></td></tr></table></figure>
<h3 id="程序中调用"><a href="#程序中调用" class="headerlink" title="程序中调用"></a>程序中调用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">同上</span><br></pre></td></tr></table></figure>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py celery worker --loglevel=info</span><br><span class="line">   python manage.py celery beat --loglevel=info</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[rest_framework.authtoken 定制]]></title>
      <url>http://yunsonbai.github.io/2016/07/11/rest_framework_authtoken%E5%AE%9A%E5%88%B6/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">前段时间研究了一下rest_framework.authtoken，它可以实现对用户的token鉴权除了可以使用默认的配置以外，可以</span><br><span class="line">实现定制。想快速实现一套用户系统的可以看看</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="为什么要使用"><a href="#为什么要使用" class="headerlink" title="为什么要使用"></a>为什么要使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果你急于实现一套用户系统，考虑到完全自己开发所花的时间成本（有可能费劲开发完了并不适用），不妨试试稍加改动</span><br><span class="line">django自带的用户系统为自己所用，django自带的用户系统还是比较完备的，而且还有丰富的第三方库。如果想用token</span><br><span class="line">鉴权该怎么办呢，这时候rest_framework.authtoken就用上派场了，rest_framework.authtoken用起来十分简单。</span><br></pre></td></tr></table></figure>
<h2 id="在django中使用"><a href="#在django中使用" class="headerlink" title="在django中使用"></a>在django中使用</h2><h3 id="添加app"><a href="#添加app" class="headerlink" title="添加app"></a>添加app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">在INSTALLED_APPS中加入rest_framework.authtoken即可</span><br><span class="line">   INSTALLED_APPS = (</span><br><span class="line">       <span class="string">'django.contrib.admin'</span>,</span><br><span class="line">       <span class="string">'django.contrib.auth'</span>,</span><br><span class="line">       <span class="string">'django.contrib.contenttypes'</span>,</span><br><span class="line">       <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">       <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">       <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">       <span class="string">'rest_framework'</span>,</span><br><span class="line">       <span class="string">'rest_framework.authtoken'</span>,</span><br><span class="line">   )</span><br></pre></td></tr></table></figure>
<h3 id="view中使用"><a href="#view中使用" class="headerlink" title="view中使用"></a>view中使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">authentication_classes = (BasicAuthentication, TokenAuthentication)</span><br><span class="line">   permission_classes = (AllowAny,)</span><br></pre></td></tr></table></figure>
<p><a href="http://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication" target="_blank" rel="external">rest_framework</a></p>
<h2 id="定制返回码"><a href="#定制返回码" class="headerlink" title="定制返回码"></a>定制返回码</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">settings中添加：</span><br><span class="line">	 REST_FRAMEWORK = &#123;</span><br><span class="line">           <span class="string">'EXCEPTION_HANDLER'</span>: <span class="string">'ink_user.utils.rest_framework_views.exception_handler'</span>,</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="rest-framework-views-py"><a href="#rest-framework-views-py" class="headerlink" title="rest_framework_views.py"></a>rest_framework_views.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line">   from __future__ import unicode_literals</span><br><span class="line"></span><br><span class="line">   from django.core.exceptions import PermissionDenied</span><br><span class="line">   from django.http import Http404</span><br><span class="line">   from django.utils import six</span><br><span class="line">   from django.utils.translation import ugettext_lazy as _</span><br><span class="line"></span><br><span class="line">   from rest_framework import exceptions, status</span><br><span class="line">   from rest_framework.compat import <span class="built_in">set</span>_rollback</span><br><span class="line">   from rest_framework.response import Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   def exception_handler(exc, context):</span><br><span class="line">       <span class="string">""</span><span class="string">"</span><br><span class="line">       Returns the response that should be used for any given exception.</span><br><span class="line"></span><br><span class="line">       By default we handle the REST framework `APIException`, and also</span><br><span class="line">       Django's built-in `Http404` and `PermissionDenied` exceptions.</span><br><span class="line"></span><br><span class="line">       Any unhandled exceptions may return `None`, which will cause a 500 error</span><br><span class="line">       to be raised.</span><br><span class="line">       "</span><span class="string">""</span></span><br><span class="line">       <span class="keyword">if</span> isinstance(exc, exceptions.APIException):</span><br><span class="line">           headers = &#123;&#125;</span><br><span class="line">           <span class="keyword">if</span> getattr(exc, <span class="string">'auth_header'</span>, None):</span><br><span class="line">               headers[<span class="string">'WWW-Authenticate'</span>] = exc.auth_header</span><br><span class="line">           <span class="keyword">if</span> getattr(exc, <span class="string">'wait'</span>, None):</span><br><span class="line">               headers[<span class="string">'Retry-After'</span>] = <span class="string">'%d'</span> % exc.wait</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> isinstance(exc.detail, (list, dict)):</span><br><span class="line">               data = exc.detail</span><br><span class="line">           <span class="keyword">else</span>:</span><br><span class="line">               data = &#123;<span class="string">'detail'</span>: exc.detail&#125;</span><br><span class="line">               <span class="comment"># if exc.detail == 'Invalid token.':</span></span><br><span class="line">               <span class="keyword">if</span> exc.status_code == 401:</span><br><span class="line">                   data = &#123;<span class="string">'status'</span>: 401.1, <span class="string">'msg'</span>: exc.detail&#125;</span><br><span class="line">           <span class="built_in">set</span>_rollback()</span><br><span class="line">           <span class="built_in">return</span> Response(data)</span><br><span class="line">           <span class="comment"># return Response(data, status=exc.status_code, headers=headers)</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">elif</span> isinstance(exc, Http404):</span><br><span class="line">           msg = _(<span class="string">'Not found.'</span>)</span><br><span class="line">           data = &#123;<span class="string">'detail'</span>: six.text_<span class="built_in">type</span>(msg)&#125;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">set</span>_rollback()</span><br><span class="line">           <span class="built_in">return</span> Response(data, status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">elif</span> isinstance(exc, PermissionDenied):</span><br><span class="line">           msg = _(<span class="string">'Permission denied.'</span>)</span><br><span class="line">           data = &#123;<span class="string">'detail'</span>: six.text_<span class="built_in">type</span>(msg)&#125;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">set</span>_rollback()</span><br><span class="line">           <span class="built_in">return</span> Response(data, status=status.HTTP_403_FORBIDDEN)</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Note: Unhandled exceptions will raise a 500 error.</span></span><br><span class="line">       <span class="built_in">return</span> None</span><br></pre></td></tr></table></figure>
<h2 id="note"><a href="#note" class="headerlink" title="note"></a>note</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">重点在于：</span><br><span class="line">   	settings中的配置；</span><br><span class="line">       rest_framework_views.py 重写：</span><br><span class="line">       	<span class="keyword">if</span> exc.status_code == 401:</span><br><span class="line">               <span class="comment"># 此处定义自己的消息体</span></span><br><span class="line">               data = &#123;<span class="string">'status'</span>: 401.1, <span class="string">'msg'</span>: exc.detail&#125;</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[多方位监控webServer]]></title>
      <url>http://yunsonbai.github.io/2016/07/02/%E5%A4%9A%E6%96%B9%E4%BD%8D%E7%9B%91%E6%8E%A7webServer/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">最近趁着开发需求较少，着手整理了一段时间关于系统监控的东西，系统监控的目的就是为了快速的发现系统问题、找到问题所在、并</span><br><span class="line">解决它。下边分享一下</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="初识监控"><a href="#初识监控" class="headerlink" title="初识监控"></a>初识监控</h2><h3 id="懵懂"><a href="#懵懂" class="headerlink" title="懵懂"></a>懵懂</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">记得当初来公司的时候，师傅让我在代码关键的部位打日志，初来乍到，以为日志嘛，还按照上边的写的例子接着写得了。学习期间</span><br><span class="line">知道该方法是为了帮助排错用的，但是该怎么用，怎么打并没有好好研究过，甚至还有怀疑，既然测试人员已经测试好了还有必要再在</span><br><span class="line">业务部分加吗，这样不会降低系统的处理效率吗？</span><br></pre></td></tr></table></figure>
<h3 id="第一次使用日志"><a href="#第一次使用日志" class="headerlink" title="第一次使用日志"></a>第一次使用日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">好景不长，没多久就出了一个很奇怪的问题，大部分情况下系统正常，但是总有意外发生（而且是事后一段时间后才发现，因为当时</span><br><span class="line">没有加报错邮件），很是烦恼，苦恼时刻想到了曾经师傅让打的日志，开始用grep过滤这个意外的问题，很快找到了问题所在，多亏</span><br><span class="line">日志是仿照前辈打的（当时完全不知道人家为啥要那样打）。从那感受到了日志的魅力。</span><br></pre></td></tr></table></figure>
<h3 id="如何打"><a href="#如何打" class="headerlink" title="如何打"></a>如何打</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">原则，不能因为添加监控而导致服务质量大幅度下滑, 打关键点不乱打</span><br></pre></td></tr></table></figure>
<h3 id="开始谈这段时间的结果"><a href="#开始谈这段时间的结果" class="headerlink" title="开始谈这段时间的结果"></a>开始谈这段时间的结果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">上边说的有点废话，但是对于刚毕业的学生来讲，很多人会遇到这样的情况，下边开始说说这段时间是怎么来监控我们的系统的。</span><br></pre></td></tr></table></figure>
<h2 id="报错邮件的添加"><a href="#报错邮件的添加" class="headerlink" title="报错邮件的添加"></a>报错邮件的添加</h2><h3 id="重要性"><a href="#重要性" class="headerlink" title="重要性"></a>重要性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我们知道在稳定的系统，都有可能因为这样或那样的问题（硬件、网络等问题）导致出错，尤其是在系统中调用第三方接口的代</span><br><span class="line">码段，第三方的接口是不可控的，换句话说就是这些地方极易出现问题。所以这些地方需要有报警邮件及时通知。</span><br></pre></td></tr></table></figure>
<h3 id="添加报警模块"><a href="#添加报警模块" class="headerlink" title="添加报警模块"></a>添加报警模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">之前我写过一篇文章，是如何利用sentry（采用Django开发，当然有其他的可以留言讨论）来监控系统，如下是连接，sentry</span><br><span class="line">可以使全局的监控，也可以是部分代码段的监控，在部分代码段的监控上建议使用try语句监控，这样避免致服务中断，给用户不</span><br><span class="line">好的体验。</span><br></pre></td></tr></table></figure>
<p><a href="https://www.yunsonbai.top/2016/05/30/django-sentry/" target="_blank" rel="external">利用sentry收集django的日志</a></p>
<h2 id="Api响应时间的监控"><a href="#Api响应时间的监控" class="headerlink" title="Api响应时间的监控"></a>Api响应时间的监控</h2><h3 id="必要性"><a href="#必要性" class="headerlink" title="必要性"></a>必要性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">关于api的响应时间监控显然很重要，如果你能实时或准实时的看到你写的接口的响应时间的话，你就会很有目的性的去优化你的</span><br><span class="line">接口，就能提供更好的服务。在调用第三方接口的地方最好也能加上监控，因为有可能你接口慢就是由于第三方的接口导致的。</span><br></pre></td></tr></table></figure>
<h3 id="准实时监控"><a href="#准实时监控" class="headerlink" title="准实时监控"></a>准实时监控</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我叫它准实时因为过一小段时间后我们才能知道结果。</span><br></pre></td></tr></table></figure>
<h4 id="利用nginx日志"><a href="#利用nginx日志" class="headerlink" title="利用nginx日志"></a>利用nginx日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在nginx日志中可以根据<span class="variable">$request_time</span>(全程的时间：从用户点击到所有结果返回）和<span class="variable">$upstream_response_time</span>（Nginx</span><br><span class="line">向后端建立连接开始到接受完数据然后关闭连接为止的时间），可以根据需求来利用这两个参数的值。当然你需要写一个日志分析</span><br><span class="line">脚本，这个不难。</span><br></pre></td></tr></table></figure>
<h4 id="利用diamond"><a href="#利用diamond" class="headerlink" title="利用diamond"></a>利用diamond</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">diamond是可以实现类似于定期任务的工具,可以监控系统内存、CPU使用情况等等，你可以事先写好代码片段去请求自己的接口，</span><br><span class="line">然后加到diamond的collectors中，定期执行，它能给你在单位时间内系统的监控参数。可以看一下之前的文章。</span><br></pre></td></tr></table></figure>
<p><a href="https://www.yunsonbai.top/2016/06/13/python-diamond/" target="_blank" rel="external">使用diamond监控系统或api</a></p>
<h3 id="实时监控"><a href="#实时监控" class="headerlink" title="实时监控"></a>实时监控</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">个人觉得最好只监控api中的关键部位，因为他将会影响api的整体</span><br><span class="line">响应时间。</span><br></pre></td></tr></table></figure>
<h4 id="利用Metrology"><a href="#利用Metrology" class="headerlink" title="利用Metrology"></a>利用Metrology</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line">from metrology import Metrology</span><br><span class="line">from metrology.reporter import GraphiteReporter</span><br><span class="line"></span><br><span class="line">class ApiTimer(object):</span><br><span class="line"></span><br><span class="line">	__instance = None</span><br><span class="line"></span><br><span class="line">	def __init__(self, key, carbon_host, carbon_port):</span><br><span class="line">		self.timer = Metrology.timer(key)</span><br><span class="line">		self.carbon_host = carbon_host</span><br><span class="line">		self.carbon_port = carbon_port</span><br><span class="line"></span><br><span class="line">	def reporte(self):</span><br><span class="line">		<span class="comment"># 主要负责往传输统计结果</span></span><br><span class="line">		reporter = GraphiteReporter(self.carbon_host, self.carbon_port)</span><br><span class="line">		reporter.write()</span><br><span class="line"></span><br><span class="line">	def probe(self, func, *arg, **args):</span><br><span class="line">		<span class="comment"># 代理执行函数</span></span><br><span class="line">		st = time.time()</span><br><span class="line">		res = func(*arg, **args)</span><br><span class="line">		self.timer.update(int((time.time() - st) * 1000))</span><br><span class="line">		last_tick = self.timer.meter.last_tick.value</span><br><span class="line">		<span class="keyword">if</span> last_tick - self.timer.meter.start_time &gt; 2:</span><br><span class="line">			self.reporte()</span><br><span class="line">			self.timer.clear()</span><br><span class="line">		<span class="built_in">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def fun(a):</span><br><span class="line">	pass</span><br><span class="line">	<span class="comment"># time.sleep(random.random())</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="comment"># 以下是测试用例</span></span><br><span class="line">	<span class="comment"># import random</span></span><br><span class="line">	st = time.time()</span><br><span class="line">	timer = ApiTimer(<span class="string">'test1.test'</span>, <span class="string">'xx.xx.xx.xx'</span>, xx)</span><br><span class="line">	<span class="keyword">while</span> time.time() - st &lt; 20:</span><br><span class="line">		timer.probe(fun, 1)</span><br></pre></td></tr></table></figure>
<h2 id="关键部位info日志添加"><a href="#关键部位info日志添加" class="headerlink" title="关键部位info日志添加"></a>关键部位info日志添加</h2><h3 id="重要性-1"><a href="#重要性-1" class="headerlink" title="重要性"></a>重要性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">有时候你会遇到这样的问题：api响应时间超短，也没有报错邮件，但是就是结果不对。这一般是返回结果出了问题，遇到最多</span><br><span class="line">的就是在调用第三方接口的时候出了这样的问题，这时候就需要有info日志来帮忙了。打日志最好使用,|:分隔符分开关键的参</span><br><span class="line">数和返回值，方便过滤。</span><br></pre></td></tr></table></figure>
<h3 id="在api中关键断码段打印日志"><a href="#在api中关键断码段打印日志" class="headerlink" title="在api中关键断码段打印日志"></a>在api中关键断码段打印日志</h3><h4 id="使用sentry"><a href="#使用sentry" class="headerlink" title="使用sentry"></a>使用sentry</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sentry除了能监控error日志，还能收集info日志，你可以尝试使用。但是sentry打的info日志会有很多额外的信息。可以</span><br><span class="line">去前边的链接中看怎么使用。</span><br></pre></td></tr></table></figure>
<h4 id="使用rsyslog"><a href="#使用rsyslog" class="headerlink" title="使用rsyslog"></a>使用rsyslog</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该方法比较通用，不论在什么开发语言和框架下，基本上都支持对rsyslog的</span><br><span class="line">使用。我前边写了一篇在Django中使用rsyslog，可以看一下。</span><br></pre></td></tr></table></figure>
<p><a href="https://www.yunsonbai.top/2016/06/08/django-rsyslog/" target="_blank" rel="external">使用rsyslog收集Django的日志</a></p>
<h3 id="收集远程日志"><a href="#收集远程日志" class="headerlink" title="收集远程日志"></a>收集远程日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">前边说了日志打印，下边说一下如何收集这些日志。</span><br></pre></td></tr></table></figure>
<h4 id="服务器写传输脚本，定期执行"><a href="#服务器写传输脚本，定期执行" class="headerlink" title="服务器写传输脚本，定期执行"></a>服务器写传输脚本，定期执行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">有点low，但也不失为一种办法</span><br></pre></td></tr></table></figure>
<h4 id="使用rsyslog-1"><a href="#使用rsyslog-1" class="headerlink" title="使用rsyslog"></a>使用rsyslog</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当然如果你使用的是使用的是sentry收集info日志，你不用操心怎么收集，因为sentry都帮你做好了。如果是使用的rsyslog的</span><br><span class="line">话你就需要收集服务器上的日志了。rsyslog除了可以帮你本地打印日志，还能远程收集日志。可以走默认端口514来收集，当然</span><br><span class="line">需要把web服务器上的rsyslog配置成远程传输的方式，即通过514端口输出日志到远端rsyslog日志服务器上。</span><br></pre></td></tr></table></figure>
<h4 id="使用syslog-ng收集"><a href="#使用syslog-ng收集" class="headerlink" title="使用syslog-ng收集"></a>使用syslog-ng收集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syslog-ng收集日志的方式和rsyslog一样都是走514端口，但是syslog-ng可以很方便的根据关键词帮你进行日志过滤，这样的</span><br><span class="line">话你就不用苦恼于web应用太多而<span class="built_in">local</span>只能从（0-7）总感觉不够用，但是关于rsyslog和syslog-ng的比较大家可以在网上搜</span><br><span class="line">搜，毕竟这里只是提供方法。</span><br></pre></td></tr></table></figure>
<h4 id="使用ELK"><a href="#使用ELK" class="headerlink" title="使用ELK"></a>使用ELK</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用ELK，何为ELK：</span><br><span class="line">	e:</span><br><span class="line">         elasticsearch，搜索引擎，创建索引，存储数据</span><br><span class="line">    	l:</span><br><span class="line">         logstash， 日志收集，过滤，传输日志到elasticsearch</span><br><span class="line">    	k:</span><br><span class="line">         kibana， web展示</span><br><span class="line">用这个日至系统的好处就是能直接通过浏览器访问你的日志，免去了grep操作。目前我们有部分系统采用ELK。</span><br><span class="line">关于如何搭建请点击下边的链接。</span><br></pre></td></tr></table></figure>
<p><a href="https://www.yunsonbai.top/2016/07/01/ELK%E5%AE%9E%E6%97%B6%E6%97%A5%E5%BF%97%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA/" target="_blank" rel="external">ELK系统搭建</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">至此，从error监控、api响应时间监控、关键代码段响应时间监控、info日志打印四个角度对webServer做了多方位的监控，这</span><br><span class="line">些监控是为了方便你及时修改系统bug和做优化的。如何选择还是要根据具体情况而定，总之一定要遵循这样的原则：不能因为监控</span><br><span class="line">系统而拖垮服务，最终目的是为了更好的提供服务。</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ELK日志平台搭建]]></title>
      <url>http://yunsonbai.github.io/2016/07/01/ELK%E5%AE%9E%E6%97%B6%E6%97%A5%E5%BF%97%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在系统问题排查时，尤其是在第三方接口出问题的时候，貌似是自己写的服务异常，其实不然，这样很是浪费自己时间，错误在第三方</span><br><span class="line">接口。所以日志收集整理，很重要，能帮助我们排错。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="可选择的日志收集方式"><a href="#可选择的日志收集方式" class="headerlink" title="可选择的日志收集方式"></a>可选择的日志收集方式</h2><h3 id="rsyslog收集"><a href="#rsyslog收集" class="headerlink" title="rsyslog收集"></a>rsyslog收集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">走514端口，收集远程服务器打来的日志，可以根据<span class="built_in">local</span>级别（0-7）过滤，也可以根据内容（不太方便），最终要使用grep去服务</span><br><span class="line">   器上过滤排查</span><br></pre></td></tr></table></figure>
<h3 id="syslog-ng收集"><a href="#syslog-ng收集" class="headerlink" title="syslog-ng收集"></a>syslog-ng收集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">和rsyslog差不多，在根据内容过滤上，本人认为还是比较方便的，但是同样得用grep去机器上过滤想要的东西。</span><br></pre></td></tr></table></figure>
<h3 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">何为ELK：</span><br><span class="line">	e:</span><br><span class="line">         elasticsearch，搜索引擎，创建索引，存储数据</span><br><span class="line">    	l:</span><br><span class="line">         logstash， 日志收集，过滤，传输日志到elasticsearch</span><br><span class="line">    	k:</span><br><span class="line">这个不错，可以在web页面查看，还能方便的过滤，所以可以尝试一下这个。</span><br></pre></td></tr></table></figure>
<h2 id="ELK的搭建"><a href="#ELK的搭建" class="headerlink" title="ELK的搭建"></a>ELK的搭建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">网上有很多类似的，下边是我一边搭建一边整理的，没有意外是可以的。</span><br><span class="line">环境：</span><br><span class="line">	centos6</span><br></pre></td></tr></table></figure>
<h3 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h3><h4 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">建议去官网下载，我使用的是1.4.4下载elasticsearch-1.4.4.tar.gz后解压</span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim elasticsearch-1.4.4/config/elasticsearch.yml</span><br><span class="line">  	添加如下：</span><br><span class="line">	cluster.name: elasticsearch  （不能用root用户）</span><br><span class="line">	node.name: <span class="string">"node1"</span></span><br><span class="line">	node.master: <span class="literal">true</span></span><br><span class="line">    	node.data: <span class="literal">true</span></span><br><span class="line">    	network.bind_host: 192.168.xx.xx</span><br></pre></td></tr></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh elasticsearch-1.4.4/bin/elasticsearch </span><br><span class="line">   （所有的服务通过后建议写脚本采用后台运行）</span><br><span class="line">看到9200和9300端口说明启动成功</span><br></pre></td></tr></table></figure>
<h3 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">原则，不能因为添加监控而导致服务质量大幅度下滑。</span><br></pre></td></tr></table></figure>
<h4 id="版本说明-1"><a href="#版本说明-1" class="headerlink" title="版本说明"></a>版本说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">官方下载，我使用的是logstash-1.5.4。</span><br></pre></td></tr></table></figure>
<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">vim test.conf</span><br><span class="line">input &#123;</span><br><span class="line">   	file &#123;</span><br><span class="line">    	path =&gt; <span class="string">"/var/log/messages"</span></span><br><span class="line">    	<span class="built_in">type</span> =&gt; <span class="string">"syslog"</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment"># 如果用远程的收集话，要使用udp方式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line"></span><br><span class="line">   	<span class="comment">#test</span></span><br><span class="line">   	<span class="keyword">if</span> [message] =~ /TEST/ &#123;</span><br><span class="line">       	mutate&#123;</span><br><span class="line">			<span class="comment"># 可取官方文档中找，添加你想要的参数</span></span><br><span class="line">		&#125;</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   	<span class="comment">#test</span></span><br><span class="line">   	<span class="keyword">if</span> [message】 =~ /TEST$/&#123;</span><br><span class="line">       	elasticsearch &#123; host =&gt;  <span class="string">"192.168.xx.xx"</span></span><br><span class="line">           	protocol =&gt; <span class="string">"http"</span></span><br><span class="line">           	index =&gt; <span class="string">"test-%&#123;+YYYY.MM&#125;"</span></span><br><span class="line">           	manage_template  =&gt; <span class="literal">false</span></span><br><span class="line">       	&#125;</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh logstash-1.5.4/bin/logstash</span><br></pre></td></tr></table></figure>
<h3 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h3><h4 id="版本说明-2"><a href="#版本说明-2" class="headerlink" title="版本说明"></a>版本说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">官网下载，我使用的是4.1.1</span><br></pre></td></tr></table></figure>
<h4 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim config/kibana.yml</span><br><span class="line">  	添加如下：</span><br><span class="line">	elasticsearch_url: <span class="string">"http://192.168.xx.xx:9200"</span></span><br><span class="line">	其他的不动</span><br></pre></td></tr></table></figure>
<h4 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh bin/kibana</span><br><span class="line">   看到5601就行了</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">往配置的文件中打印日志，在kibana的setting中配置一条[text-]YY.MM，</span><br><span class="line">   就能看到你的日志了，还可以根据需求定制显示哪一部分</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用diamond监控系统或api]]></title>
      <url>http://yunsonbai.github.io/2016/06/13/python-diamond/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如何保证系统或api在出问题的时候及时发现并解决呢？这就需要用到监控系统，监控系统可以是实时监控，也可以是</span><br><span class="line">非实时的（需要定时去检查系统），这里说一下用diamond实现非实时监控</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/Diamond</span></span><br><span class="line"><span class="comment"># git clone git@github.com:python-diamond/Diamond.git</span></span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="diamond配置（-conf-diamond-conf）"><a href="#diamond配置（-conf-diamond-conf）" class="headerlink" title="diamond配置（./conf/diamond.conf）"></a>diamond配置（./conf/diamond.conf）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">[server]</span><br><span class="line"></span><br><span class="line">handlers = diamond.handler.graphite.GraphiteHandler, diamond.handler.archive.ArchiveHandler</span><br><span class="line"></span><br><span class="line"><span class="comment"># User diamond will run as</span></span><br><span class="line"><span class="comment"># Leave empty to use the current user</span></span><br><span class="line">user =</span><br><span class="line"></span><br><span class="line"><span class="comment"># Group diamond will run as</span></span><br><span class="line"><span class="comment"># Leave empty to use the current group</span></span><br><span class="line">group =</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pid file</span></span><br><span class="line">pid_file = /xx/Diamond/run/diamond.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># Directory to load collector modules from</span></span><br><span class="line">collectors_path = /xx/Diamond/share/diamond/collectors/</span><br><span class="line">collectors_config_path = /xx/Diamond/conf/collectors/</span><br><span class="line">collectors_reload_interval = 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Directory to load handler configs from</span></span><br><span class="line">handlers_config_path = /xx/Diamond/conf/handlers/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Directory to load handler modules from</span></span><br><span class="line">handlers_path = /xx/Diamond/share/diamond/handlers/</span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">### Options for handlers</span></span><br><span class="line">[handlers]</span><br><span class="line"></span><br><span class="line"><span class="comment"># daemon logging handler(s)</span></span><br><span class="line">keys = rotated_file</span><br><span class="line"></span><br><span class="line"><span class="comment">### Defaults options for all Handlers</span></span><br><span class="line">[[default]]</span><br><span class="line"></span><br><span class="line">[[ArchiveHandler]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># File to write archive log files</span></span><br><span class="line"><span class="built_in">log</span>_file = /var/<span class="built_in">log</span>/diamond/archive.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Number of days to keep archive log files</span></span><br><span class="line">days = 7</span><br><span class="line"></span><br><span class="line">[[GraphiteHandler]]</span><br><span class="line"><span class="comment">### Options for GraphiteHandler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphite server host(本人认为携程carbon比较合适)</span></span><br><span class="line">host = xx.xx.xx.xx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Port to send metrics to</span></span><br><span class="line">port = 2003</span><br><span class="line"></span><br><span class="line"><span class="comment"># Socket timeout (seconds)</span></span><br><span class="line">timeout = 15</span><br><span class="line"></span><br><span class="line"><span class="comment"># Batch size for metrics</span></span><br><span class="line">batch = 1</span><br><span class="line"></span><br><span class="line">[[GraphitePickleHandler]]</span><br><span class="line"><span class="comment">### Options for GraphitePickleHandler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphite server host(本人认为携程carbon比较合适)</span></span><br><span class="line">host = xx.xx.xx.xx  <span class="comment">#写你搭建好的carbon服务器地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port to send metrics to</span></span><br><span class="line">port = 2004</span><br><span class="line"></span><br><span class="line"><span class="comment"># Socket timeout (seconds)</span></span><br><span class="line">timeout = 15</span><br><span class="line"></span><br><span class="line"><span class="comment"># Batch size for pickled metrics</span></span><br><span class="line">batch = 256</span><br><span class="line"></span><br><span class="line">[[MySQLHandler]]</span><br><span class="line"><span class="comment">### Options for MySQLHandler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL Connection Info</span></span><br><span class="line">hostname    = xx.xx.xx.xx</span><br><span class="line">port        = xx</span><br><span class="line">username    = xx</span><br><span class="line">password    = xx</span><br><span class="line">database    = diamond</span><br><span class="line">table       = metrics</span><br><span class="line"><span class="comment"># INT UNSIGNED NOT NULL</span></span><br><span class="line">col_time    = timestamp</span><br><span class="line"><span class="comment"># VARCHAR(255) NOT NULL</span></span><br><span class="line">col_metric  = metric</span><br><span class="line"><span class="comment"># VARCHAR(255) NOT NULL</span></span><br><span class="line">col_value   = value</span><br><span class="line"></span><br><span class="line">[[StatsdHandler]]</span><br><span class="line">host = 127.0.0.1</span><br><span class="line">port = 8125</span><br><span class="line"></span><br><span class="line">[[TSDBHandler]]</span><br><span class="line">host = 127.0.0.1</span><br><span class="line">port = 4242</span><br><span class="line">timeout = 15</span><br><span class="line"></span><br><span class="line">[[LibratoHandler]]</span><br><span class="line">user = user@example.com</span><br><span class="line">apikey = abcdefghijklmnopqrstuvwxyz0123456789abcdefghijklmnopqrstuvwxyz01</span><br><span class="line"></span><br><span class="line">[[HostedGraphiteHandler]]</span><br><span class="line">apikey = abcdefghijklmnopqrstuvwxyz0123456789abcdefghijklmnopqrstuvwxyz01</span><br><span class="line">timeout = 15</span><br><span class="line">batch = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># And any other config settings from GraphiteHandler are valid here</span></span><br><span class="line"></span><br><span class="line">[[HttpPostHandler]]</span><br><span class="line"></span><br><span class="line"><span class="comment">### Urp to post the metrics</span></span><br><span class="line">url = http://localhost:8888/</span><br><span class="line"><span class="comment">### Metrics batch size</span></span><br><span class="line">batch = 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">### Options for collectors</span></span><br><span class="line">[collectors]</span><br><span class="line">[[default]]</span><br><span class="line"><span class="comment">### Defaults options for all Collectors</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment and set to hardcode a hostname for the collector path</span></span><br><span class="line"><span class="comment"># Keep in mind, periods are seperators in graphite</span></span><br><span class="line"><span class="comment"># hostname = my_custom_hostname</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you prefer to just use a different way of calculating the hostname</span></span><br><span class="line"><span class="comment"># Uncomment and set this to one of these values:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># smart             = Default. Tries fqdn_short. If that's localhost, uses hostname_short</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fqdn_short        = Default. Similar to hostname -s</span></span><br><span class="line"><span class="comment"># fqdn              = hostname output</span></span><br><span class="line"><span class="comment"># fqdn_rev          = hostname in reverse (com.example.www)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># uname_short       = Similar to uname -n, but only the first part</span></span><br><span class="line"><span class="comment"># uname_rev         = uname -r in reverse (com.example.www)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hostname_short    = `hostname -s`</span></span><br><span class="line"><span class="comment"># hostname          = `hostname`</span></span><br><span class="line"><span class="comment"># hostname_rev      = `hostname` in reverse (com.example.www)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># shell             = Run the string set in hostname as a shell command and use its</span></span><br><span class="line"><span class="comment">#                     output(with spaces trimmed off from both ends) as the hostname.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hostname_method = smart</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path Prefix and Suffix</span></span><br><span class="line"><span class="comment"># you can use one or both to craft the path where you want to put metrics</span></span><br><span class="line"><span class="comment"># such as: %(path_prefix)s.$(hostname)s.$(path_suffix)s.$(metric)s</span></span><br><span class="line">path_prefix = servers <span class="comment">#在graphite显示的最外层名字</span></span><br><span class="line"><span class="comment"># path_suffix =</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path Prefix for Virtual Machines</span></span><br><span class="line"><span class="comment"># If the host supports virtual machines, collectors may report per</span></span><br><span class="line"><span class="comment"># VM metrics. Following OpenStack nomenclature, the prefix for</span></span><br><span class="line"><span class="comment"># reporting per VM metrics is "instances", and metric foo for VM</span></span><br><span class="line"><span class="comment"># bar will be reported as: instances.bar.foo...</span></span><br><span class="line"><span class="comment"># instance_prefix = instances</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default Poll Interval (seconds)</span></span><br><span class="line">interval = 10  <span class="comment">#(所有的监控多长时间执行一次，并发送数据给carbon)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################</span></span><br><span class="line"><span class="comment"># Default enabled collectors</span></span><br><span class="line"><span class="comment">########################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[[CPUCollector]]</span></span><br><span class="line"><span class="comment">#enabled = True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[[DiskSpaceCollector]]</span></span><br><span class="line"><span class="comment">#enabled = True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[[DiskUsageCollector]]</span></span><br><span class="line"><span class="comment">#enabled = True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[[LoadAverageCollector]]</span></span><br><span class="line"><span class="comment">#enabled = True</span></span><br><span class="line"></span><br><span class="line">[[MemoryCollector]]</span><br><span class="line">enabled = True</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[VMStatCollector]]</span></span><br><span class="line"><span class="comment">#enabled = True</span></span><br><span class="line"></span><br><span class="line">[loggers]</span><br><span class="line"></span><br><span class="line">keys = root</span><br><span class="line"></span><br><span class="line"><span class="comment"># handlers are higher in this config file, in:</span></span><br><span class="line"><span class="comment"># [handlers]</span></span><br><span class="line"><span class="comment"># keys = ...</span></span><br><span class="line"></span><br><span class="line">[formatters]</span><br><span class="line"></span><br><span class="line">keys = default</span><br><span class="line"></span><br><span class="line">[logger_root]</span><br><span class="line"></span><br><span class="line"><span class="comment"># to increase verbosity, set DEBUG</span></span><br><span class="line">level = INFO</span><br><span class="line">handlers = rotated_file</span><br><span class="line">propagate = 1</span><br><span class="line"></span><br><span class="line">[handler_rotated_file]</span><br><span class="line"></span><br><span class="line">class = handlers.TimedRotatingFileHandler</span><br><span class="line">level = DEBUG</span><br><span class="line">formatter = default</span><br><span class="line"><span class="comment"># rotate at midnight, each day and keep 7 days</span></span><br><span class="line">args = (<span class="string">'/var/log/diamond/diamond.log'</span>, <span class="string">'midnight'</span>, 1, 7)</span><br><span class="line"></span><br><span class="line">[formatter_default]</span><br><span class="line"></span><br><span class="line">format = [%(asctime)s] [%(threadName)s] %(message)s</span><br><span class="line">datefmt =</span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line"><span class="comment">### Options for config merging</span></span><br><span class="line"><span class="comment"># [configs]</span></span><br><span class="line"><span class="comment"># path = "/etc/diamond/configs/"</span></span><br><span class="line"><span class="comment"># extension = ".conf"</span></span><br><span class="line"><span class="comment">#----------------------------------------------</span></span><br><span class="line"><span class="comment"># Example:</span></span><br><span class="line"><span class="comment"># /etc/diamond/configs/net.conf</span></span><br><span class="line"><span class="comment"># [collectors]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># [[NetworkCollector]]</span></span><br><span class="line">          <span class="comment"># enabled = True</span></span><br></pre></td></tr></table></figure>
<h3 id="数据库支持（mysql）"><a href="#数据库支持（mysql）" class="headerlink" title="数据库支持（mysql）"></a>数据库支持（mysql）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database diamond</span><br></pre></td></tr></table></figure>
<h3 id="增加MemoryCollector（当然按照上边的配置还能加其他的）"><a href="#增加MemoryCollector（当然按照上边的配置还能加其他的）" class="headerlink" title="增加MemoryCollector（当然按照上边的配置还能加其他的）"></a>增加MemoryCollector（当然按照上边的配置还能加其他的）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在目录/xx/Diamond/share/diamond/collectors/中添加一个py文件</span><br><span class="line">该文件diamond已经写好，在src目录下寻找一下</span><br><span class="line">（src/collectors/memory/memory.py）</span><br></pre></td></tr></table></figure>
<h3 id="增加自己的Collector"><a href="#增加自己的Collector" class="headerlink" title="增加自己的Collector"></a>增加自己的Collector</h3><h4 id="添加ExampleCollector-conf"><a href="#添加ExampleCollector-conf" class="headerlink" title="添加ExampleCollector.conf"></a>添加ExampleCollector.conf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在/xx/Diamond/conf/collectors/添加一个ExampleCollector.conf</span><br><span class="line">（你也可以是其他的名字，xxCollector.conf ）</span><br></pre></td></tr></table></figure>
<h4 id="添加ExampleCollector-py"><a href="#添加ExampleCollector-py" class="headerlink" title="添加ExampleCollector.py"></a>添加ExampleCollector.py</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">在/xx/Diamond/share/diamond/collectors/中添加ExampleCollector.py</span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line">import diamond.collector</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def <span class="built_in">test</span>():</span><br><span class="line">    <span class="comment"># dosomething</span></span><br><span class="line">    pass   </span><br><span class="line"></span><br><span class="line">class ExampleCollector(diamond.collector.Collector):</span><br><span class="line"></span><br><span class="line">    def collect(self):</span><br><span class="line">        metric_name = <span class="string">"my.example.metric"</span></span><br><span class="line">        st = time.time()</span><br><span class="line">        <span class="built_in">test</span>()</span><br><span class="line">        et = time.time()</span><br><span class="line">        metric_value = (et - st) * 1000</span><br><span class="line">        self.publish(metric_name, metric_value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/Diamond</span></span><br><span class="line"><span class="comment"># python ./bin/diamond -lf -c ./conf/diamond.conf</span></span><br></pre></td></tr></table></figure>
<h3 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以到已经搭建好的graphite（待我整理完会补充，也可以到网上搜一下）</span><br><span class="line">后台查看应该会有 /Metrics/servers .....</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://diamond.readthedocs.io/en/latest/" target="_blank" rel="external">Diamond</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[nginx实现https]]></title>
      <url>http://yunsonbai.github.io/2016/06/09/nginx-https%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器，下边说一下nginx关于https的配置</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="使用ssl生成证书"><a href="#使用ssl生成证书" class="headerlink" title="使用ssl生成证书"></a>使用ssl生成证书</h2><h3 id="生成命令"><a href="#生成命令" class="headerlink" title="生成命令"></a>生成命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout </span></span><br><span class="line">   /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt</span><br></pre></td></tr></table></figure>
<h3 id="输入完命令后的提示"><a href="#输入完命令后的提示" class="headerlink" title="输入完命令后的提示"></a>输入完命令后的提示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">提示如下，一步一步完成即可（也可以使用默认，也可随意）：</span><br><span class="line">Country Name (2 letter code) [AU]:China</span><br><span class="line">   State or Province Name (full name) [Some-State]: Beijing</span><br><span class="line">   Locality Name (eg, city) []:Beijing</span><br><span class="line">   Organization Name (eg, company) [Internet Widgits Pty Ltd]:Bouncy Castles, Inc.</span><br><span class="line">   Organizational Unit Name (eg, section) []:Ministry of Water Slides</span><br><span class="line">   Common Name (e.g. server FQDN or YOUR name) []:your_domain.com</span><br><span class="line">   Email Address []:admin@your_domain.com</span><br></pre></td></tr></table></figure>
<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><h3 id="打开-conf文件"><a href="#打开-conf文件" class="headerlink" title="打开.conf文件"></a>打开.conf文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/nginx、nginx.conf文件</span><br><span class="line">   vim nginx.conf</span><br></pre></td></tr></table></figure>
<h3 id="添加如下配置"><a href="#添加如下配置" class="headerlink" title="添加如下配置"></a>添加如下配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">     listen 80;</span><br><span class="line">     server_name www.xxx.xxx;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">	listen 443 ssl;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    location /static/ &#123;</span><br><span class="line">    	<span class="built_in">alias</span>   /<span class="built_in">test</span>/static/;</span><br><span class="line">        expires 24h;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -c /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>
<h3 id="创建静态页"><a href="#创建静态页" class="headerlink" title="创建静态页"></a>创建静态页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /test/static</span><br><span class="line">touch test.html</span><br><span class="line">echo &apos;test https&apos; &gt; test.html</span><br></pre></td></tr></table></figure>
<h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在浏览器中访问https:127..0.1/static/test.html</span><br></pre></td></tr></table></figure>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">最近发现了一个很奇怪的问题，就是使用python在访问https下的链接的时候一切正常</span><br><span class="line">然而在ios9下访问就会时不时的出现1004问题（访问不到）,最后的解决办法是使用最</span><br><span class="line">新的nginx解决</span><br></pre></td></tr></table></figure>
<p><a href="http://www.yunsonbai.top/2016/06/09/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" target="_blank" rel="external">nginx常用配置</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[当eth0没有ipv4地址的解决办法]]></title>
      <url>http://yunsonbai.github.io/2016/06/09/eth0-no-ipv4/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">有时候我们在Linux使用ifconfig后发现没有ipv4地址，下边说一下解决办法</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="打开ubuntu的-etc-network-interfaces"><a href="#打开ubuntu的-etc-network-interfaces" class="headerlink" title="打开ubuntu的/etc/network/interfaces"></a>打开ubuntu的/etc/network/interfaces</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">删除已经有的，后根据喜好选择添加如下</span><br><span class="line">自动：</span><br><span class="line">         auto eth0</span><br><span class="line">         iface eth0 inet dhcp</span><br><span class="line">    静态分配的配置方法：</span><br><span class="line">         auto eth0</span><br><span class="line">         iface eth0 inet static</span><br><span class="line">         address 192.168.205.139</span><br><span class="line">         netmask  255.255.255.0</span><br><span class="line">         gateway  192.168.205.1</span><br></pre></td></tr></table></figure>
<h2 id="添加域名服务器"><a href="#添加域名服务器" class="headerlink" title="添加域名服务器"></a>添加域名服务器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">打开/etc/resolv.conf文件</span><br><span class="line">   添加这行:nameserver 127.0.0.1</span><br></pre></td></tr></table></figure>
<h2 id="重启eth0"><a href="#重启eth0" class="headerlink" title="重启eth0"></a>重启eth0</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$/etc/init.d/networking restart(这条命令是重启网卡)</span><br><span class="line"> 或者</span><br><span class="line"><span class="variable">$ifdown</span> eth0</span><br><span class="line"><span class="variable">$ifup</span>   eth0（这两条命令是有针对性的重启某个网络接口，因为一个系统可能有多个网络接口）</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[nginx常用配置]]></title>
      <url>http://yunsonbai.github.io/2016/06/09/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器，下边说一下这断时间用到的nginx配置</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><h3 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream forum  &#123;</span><br><span class="line">	server 127.0.0.1:8000 weight 1;</span><br><span class="line">	server 127.0.0.1:8001 weight 1;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       location / &#123;</span><br><span class="line">           proxy_pass         http://forum;</span><br><span class="line">           proxy_<span class="built_in">set</span>_header   Host             <span class="variable">$host</span>;</span><br><span class="line">           proxy_<span class="built_in">set</span>_header   X-Real-IP        <span class="variable">$remote_addr</span>;</span><br><span class="line">           proxy_<span class="built_in">set</span>_header   X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	location /static/ &#123;</span><br><span class="line">		proxy_<span class="built_in">set</span>_header Host test.xx.com;</span><br><span class="line">		proxy_<span class="built_in">set</span>_header Origin http://test.xx.com;</span><br><span class="line">		proxy_pass    http://test.xx.com/static1/; <span class="comment">#可以不是代理的url</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="设置与打印cookies"><a href="#设置与打印cookies" class="headerlink" title="设置与打印cookies"></a>设置与打印cookies</h2><h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name test.xx.com;</span><br><span class="line">       add_header Set-Cookie <span class="string">"name=baisong"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">log</span>_format main	<span class="string">'$http_cookie,...'</span></span><br></pre></td></tr></table></figure>
<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	location /static/ &#123;</span><br><span class="line">       	<span class="built_in">alias</span>   /<span class="built_in">test</span>/static/;</span><br><span class="line">		expires 24h;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="进程数指定"><a href="#进程数指定" class="headerlink" title="进程数指定"></a>进程数指定</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 8; <span class="comment">#最好和cpu数量一致</span></span><br></pre></td></tr></table></figure>
<h3 id="进程连接数指定"><a href="#进程连接数指定" class="headerlink" title="进程连接数指定"></a>进程连接数指定</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">worker_connections 65535;</span><br><span class="line"><span class="comment"># 每个进程允许的最多连接数， 理论上每台nginx 服务器的最大连接数为worker_processes*worker_connections。</span></span><br><span class="line">   keepalive_timeout 60;keepalive 超时时间。</span><br></pre></td></tr></table></figure>
<h3 id="头部的缓冲区大小"><a href="#头部的缓冲区大小" class="headerlink" title="头部的缓冲区大小"></a>头部的缓冲区大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=65535 inactive=60s;</span><br><span class="line"><span class="comment">#这个将为打开文件指定缓存，默认是没有启用的，max 指定缓存数量，建议和打开文件数一致，inactive 是指经过多长时间文件没被请求后删除缓存。</span></span><br></pre></td></tr></table></figure>
<h3 id="缓存检查"><a href="#缓存检查" class="headerlink" title="缓存检查"></a>缓存检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache_valid 80s;</span><br><span class="line"><span class="comment"># 这个是指多长时间检查一次缓存的有效信息。</span></span><br></pre></td></tr></table></figure>
<h3 id="控制缓冲区溢出攻击"><a href="#控制缓冲区溢出攻击" class="headerlink" title="控制缓冲区溢出攻击"></a>控制缓冲区溢出攻击</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client_body_buffer_size  1K;</span><br><span class="line">client_header_buffer_size 1k;</span><br><span class="line">   client_max_body_size 1k;</span><br><span class="line">   large_client_header_buffers 2 1k;</span><br></pre></td></tr></table></figure>
<h3 id="if语句"><a href="#if语句" class="headerlink" title="if语句"></a>if语句</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制可用的请求方法</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> !~ ^(GET|HEAD|POST)$ ) &#123;</span><br><span class="line">        <span class="built_in">return</span> 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="防止图片盗链"><a href="#防止图片盗链" class="headerlink" title="防止图片盗链"></a>防止图片盗链</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">只有www.example1.com example2.com 能访问</span><br><span class="line">   location /images/ &#123;</span><br><span class="line">        valid_referers none blocked www.example1.com example2.com;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">             <span class="built_in">return</span>   403;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://www.yunsonbai.top/2016/06/09/nginx-https%E9%85%8D%E7%BD%AE/" target="_blank" rel="external">nginx实现https</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用rsyslog收集Django的日志]]></title>
      <url>http://yunsonbai.github.io/2016/06/08/django-rsyslog/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">日志收集对项目很重要,在前边我写过一篇如何利用sentry收集django程序运行时的日志,我们的项目中一般用sentry</span><br><span class="line">来收集error日志，因为打的比较详细，可观性也比较强。但是我们如果把info日志达到sentry上不方便观看，所以不</span><br><span class="line">妨使用rsyslog来收集Django中的一些info日志，当然只是打我们想要的东西。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu12.04</span><br></pre></td></tr></table></figure>
<h2 id="搭建rsyslog环境"><a href="#搭建rsyslog环境" class="headerlink" title="搭建rsyslog环境"></a>搭建rsyslog环境</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在Ubuntu中默认已经装好了rsyslog，当然如果有问题你可以自己安装（使用apt-get </span><br><span class="line">install rsyslog即可，你也可以使用编译安装）</span><br></pre></td></tr></table></figure>
<h3 id="配置（-var-log-mylog-forum-log）"><a href="#配置（-var-log-mylog-forum-log）" class="headerlink" title="配置（/var/log/mylog/forum.log）"></a>配置（/var/log/mylog/forum.log）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   你可以添加类似这样一条：</span><br><span class="line"><span class="built_in">local</span>4.*        /var/<span class="built_in">log</span>/mylog/forum.log</span><br></pre></td></tr></table></figure>
<h3 id="重启rsyslog"><a href="#重启rsyslog" class="headerlink" title="重启rsyslog"></a>重启rsyslog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure>
<h2 id="在Django中使用"><a href="#在Django中使用" class="headerlink" title="在Django中使用"></a>在Django中使用</h2><h3 id="修改Djangosettings-py"><a href="#修改Djangosettings-py" class="headerlink" title="修改Djangosettings.py"></a>修改Djangosettings.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">   from logging.handlers import SysLogHandler</span><br><span class="line"></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">'version'</span>: 1,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: False,</span><br><span class="line">    <span class="string">'formatters'</span>: &#123;</span><br><span class="line">        <span class="string">'verbose'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: <span class="string">"iSync|%(levelname)s|%(asctime)s|%(module)s|%(process)d|%(thread)d|%(message)s"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'simple'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: <span class="string">"iSync|%(levelname)s|%(asctime)s|%(message)s"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="string">'null'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.NullHandler'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'console'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'verbose'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'syslog'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.handlers.SysLogHandler'</span>,</span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'simple'</span>,</span><br><span class="line">            <span class="string">'facility'</span>: SysLogHandler.LOG_LOCAL4, <span class="comment">#此处一定要和rsyslog中的local4一致</span></span><br><span class="line">            <span class="string">'address'</span>: <span class="string">'/dev/log'</span>, <span class="comment"># 机器上一定要有该文件（srw-rw-rw-）</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="string">'django.request'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'console'</span>, <span class="string">'null'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'ERROR'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: True,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'rsyslog'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'syslog'</span>, ],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: True,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在view或其他地方调用，将日志打到rsyslog"><a href="#在view或其他地方调用，将日志打到rsyslog" class="headerlink" title="在view或其他地方调用，将日志打到rsyslog"></a>在view或其他地方调用，将日志打到rsyslog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   rsysloger = logging.getLogger(<span class="string">'rsyslog'</span>)</span><br><span class="line">   rsysloger.info(<span class="string">'sdsdsdsds'</span>)</span><br><span class="line"><span class="comment"># 之后你可以去/var/log/mylog/forum.log 看结果了</span></span><br></pre></td></tr></table></figure>
<h2 id="利用sentry收集Django日志"><a href="#利用sentry收集Django日志" class="headerlink" title="利用sentry收集Django日志"></a><a href="https://www.yunsonbai.top/2016/05/30/django-sentry/" target="_blank" rel="external">利用sentry收集Django日志</a></h2>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[富文本实践]]></title>
      <url>http://yunsonbai.github.io/2016/06/08/summernote/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">前段时间趁着项目不忙自己玩了一下富文本，在html页实现富文本。</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="使用的js包"><a href="#使用的js包" class="headerlink" title="使用的js包"></a>使用的js包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">summernote</span><br></pre></td></tr></table></figure>
<h3 id="html代码"><a href="#html代码" class="headerlink" title="html代码"></a>html代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">   &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span><br><span class="line">   &lt;head&gt;</span><br><span class="line">   &lt;link href=<span class="string">"../bootstrap-3.3.5/css/bootstrap.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">   &lt;link href=<span class="string">"font-awesome-4.5.0/css/font-awesome.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">   &lt;link href=<span class="string">"summernote/dist/summernote.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">   &lt;script src=<span class="string">"../jquery-2.1.4.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=<span class="string">"../bootstrap-3.3.5/js/bootstrap.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=<span class="string">"summernote/dist/summernote.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=<span class="string">"mysummer.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=<span class="string">"mysummer.css"</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;/head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">     &lt;div id=<span class="string">"summernote"</span>&gt;Hello Summernote&lt;/div&gt;</span><br><span class="line">     &lt;span onclick=<span class="string">'getContext(this)'</span>&gt;预览&lt;/span&gt;</span><br><span class="line">   </span><br><span class="line">     &lt;div id=<span class="string">"context"</span>&gt;&lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">   &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="mysummer-js代码"><a href="#mysummer-js代码" class="headerlink" title="mysummer.js代码"></a>mysummer.js代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$(document).ready(<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">  $(<span class="string">'#summernote'</span>).summernote(&#123;</span><br><span class="line">        toolbar: [</span><br><span class="line">            [<span class="string">'style'</span>, [<span class="string">'style'</span>,<span class="string">'fontname'</span>, <span class="string">'bold'</span>, <span class="string">'italic'</span>, <span class="string">'underline'</span>,<span class="string">'fontsize'</span>,<span class="string">'color'</span>]],</span><br><span class="line">            [<span class="string">'font'</span>, [<span class="string">'strikethrough'</span>, <span class="string">'superscript'</span>, <span class="string">'subscript'</span>]],</span><br><span class="line">            [<span class="string">'para'</span>, [<span class="string">'ul'</span>, <span class="string">'ol'</span>, <span class="string">'paragraph'</span>]],</span><br><span class="line">            [<span class="string">'insert'</span>, [<span class="string">'link'</span>, <span class="string">'picture'</span>, <span class="string">'table'</span>, <span class="string">'hr'</span>]],</span><br><span class="line">            [<span class="string">'height'</span>, [<span class="string">'height'</span>]],</span><br><span class="line">            [<span class="string">'misc'</span>, [<span class="string">'redo'</span>,<span class="string">'undo'</span>,<span class="string">'help'</span>, <span class="string">'fullscreen'</span>]],</span><br><span class="line">            // [<span class="string">'view'</span>, [<span class="string">'codeview'</span>]],</span><br><span class="line">      ]</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> getContext(obj)&#123;</span><br><span class="line">     $(document).ready(<span class="function"><span class="title">function</span></span>()&#123;</span><br><span class="line">          var code = $(<span class="string">'#summernote'</span>).summernote(<span class="string">'code'</span>);</span><br><span class="line">          var context = document.getElementById(<span class="string">'context'</span>);</span><br><span class="line">          context.innerHTML=code;</span><br><span class="line"></span><br><span class="line">          var data = &#123;<span class="string">"code"</span>:$(<span class="string">'#summernote'</span>).summernote(<span class="string">'code'</span>)&#125;;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">'/whatdo/test'</span>,</span><br><span class="line">            <span class="built_in">type</span>: <span class="string">'POST'</span>,</span><br><span class="line">            data: data,</span><br><span class="line">            dataType: <span class="string">'json'</span>,</span><br><span class="line">            success: <span class="keyword">function</span>(data,status)&#123;</span><br><span class="line">                 alert(data.status)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">     &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mysummer-css代码"><a href="#mysummer-css代码" class="headerlink" title="mysummer.css代码"></a>mysummer.css代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#summernote'</span>).summernote(&#123;</span><br><span class="line"> /*  height: 700,*/</span><br><span class="line">   minHeight: null,</span><br><span class="line">   maxHeight: null,</span><br><span class="line">   focus: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h3><img src="https://yunsonbai.github.io/images/article_img/summernote.jpg">
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[利用sentry收集django的日志]]></title>
      <url>http://yunsonbai.github.io/2016/05/30/django-sentry/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">日志收集对项目很重要,利用sentry可以手机django程序运行时的日志,同时适当的配置还能发送报警邮件</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="搭建sentry环境"><a href="#搭建sentry环境" class="headerlink" title="搭建sentry环境"></a>搭建sentry环境</h2><h3 id="创建独立环境"><a href="#创建独立环境" class="headerlink" title="创建独立环境"></a>创建独立环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virtualenv sentry</span><br><span class="line">安装好MySQL 和 redis</span><br></pre></td></tr></table></figure>
<h3 id="安装sentry"><a href="#安装sentry" class="headerlink" title="安装sentry"></a>安装sentry</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install sentry</span><br></pre></td></tr></table></figure>
<h3 id="配置-env-sentry-conf-sentry-conf-py"><a href="#配置-env-sentry-conf-sentry-conf-py" class="headerlink" title="配置(/env/sentry/conf/sentry.conf.py)"></a>配置(/env/sentry/conf/sentry.conf.py)</h3><h4 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'sentry'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'123456'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="redis配置"><a href="#redis配置" class="headerlink" title="redis配置"></a>redis配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SENTRY_REDIS_OPTIONS = &#123;</span><br><span class="line">    <span class="string">'hosts'</span>: &#123;</span><br><span class="line">        0: &#123;</span><br><span class="line">            <span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">            <span class="string">'port'</span>: 6379,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">CELERY_ALWAYS_EAGER = False</span><br><span class="line">BROKER_URL = <span class="string">'redis://localhost:6379/2'</span></span><br></pre></td></tr></table></figure>
<h4 id="端口配置"><a href="#端口配置" class="headerlink" title="端口配置"></a>端口配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SENTRY_URL_PREFIX = <span class="string">'http://127.0.0.1:9000'</span></span><br><span class="line">SENTRY_WEB_HOST = <span class="string">'0.0.0.0'</span></span><br><span class="line">SENTRY_WEB_PORT = 9000</span><br><span class="line">SENTRY_WEB_OPTIONS = &#123;</span><br><span class="line">    <span class="comment"># 'workers': 3,  # the number of gunicorn workers</span></span><br><span class="line">    <span class="comment"># 'secure_scheme_headers': &#123;'X-FORWARDED-PROTO': 'https'&#125;,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="语言配置"><a href="#语言配置" class="headerlink" title="语言配置"></a>语言配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGES = (</span><br><span class="line">    (<span class="string">'en'</span>, gettext_noop(<span class="string">'English'</span>)),</span><br><span class="line">    (<span class="string">'zh-cn'</span>, gettext_noop(<span class="string">'Simplified Chinese'</span>)),</span><br><span class="line">    <span class="comment"># ('zh-cn', gettext_noop('Traditional Chinese')),</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="邮箱配置"><a href="#邮箱配置" class="headerlink" title="邮箱配置"></a>邮箱配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EMAIL_BACKEND = <span class="string">'django.core.mail.backends.smtp.EmailBackend'</span></span><br><span class="line">EMAIL_HOST = <span class="string">'mail.test.com'</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">'xxxxxx'</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">'xxxx@test.com'</span></span><br><span class="line">EMAIL_PORT = xx</span><br><span class="line"><span class="comment"># EMAIL_USE_TLS = False</span></span><br><span class="line"><span class="comment"># The email address to send on behalf of</span></span><br><span class="line">SERVER_EMAIL = <span class="string">'xxxx@test.com'</span></span><br></pre></td></tr></table></figure>
<h2 id="建立django项目并使用sentry"><a href="#建立django项目并使用sentry" class="headerlink" title="建立django项目并使用sentry"></a>建立django项目并使用sentry</h2><h3 id="建立"><a href="#建立" class="headerlink" title="建立"></a>建立</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject <span class="built_in">test</span>_sentry</span><br></pre></td></tr></table></figure>
<h3 id="配置修改"><a href="#配置修改" class="headerlink" title="配置修改"></a>配置修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,</span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">    <span class="string">'raven.contrib.django.raven_compat'</span>,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># sentry</span></span><br><span class="line">RAVEN_CONFIG = &#123;</span><br><span class="line">    <span class="string">'dsn'</span>: <span class="string">'http://0e084efb47d24bedb60d24bedb6abd95ed7:d92981b0d24bedb6abd92981b05d7@xx.xx.xx.xx:9000/1'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">故意让程序出错就OK了</span><br></pre></td></tr></table></figure>
<h3 id="收集info日志"><a href="#收集info日志" class="headerlink" title="收集info日志"></a>收集info日志</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    &apos;version&apos;: 1,</span><br><span class="line">    &apos;disable_existing_loggers&apos;: False,</span><br><span class="line">    &apos;formatters&apos;: &#123;</span><br><span class="line">        &apos;verbose&apos;: &#123;</span><br><span class="line">            &apos;format&apos;: &quot;INK|%(levelname)s|%(asctime)s|%(module)s|%(process)d|%(thread)d|%(message)s&quot;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &apos;handlers&apos;: &#123;</span><br><span class="line">        &apos;console&apos;: &#123;</span><br><span class="line">            &apos;level&apos;: &apos;DEBUG&apos;,</span><br><span class="line">            &apos;class&apos;: &apos;logging.StreamHandler&apos;,</span><br><span class="line">            &apos;formatter&apos;: &apos;verbose&apos;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &apos;info&apos;: &#123;</span><br><span class="line">            &apos;level&apos;: &apos;INFO&apos;,</span><br><span class="line">            &apos;formatter&apos;: &apos;verbose&apos;,  # 使用哪种formatters日志格式</span><br><span class="line">            &apos;class&apos;: &apos;raven.contrib.django.raven_compat.handlers.SentryHandler&apos;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &apos;loggers&apos;: &#123;</span><br><span class="line">        &apos;django.request&apos;: &#123;</span><br><span class="line">            &apos;handlers&apos;: [&apos;console&apos;],</span><br><span class="line">            &apos;level&apos;: &apos;DEBUG&apos;,</span><br><span class="line">            &apos;propagate&apos;: True,</span><br><span class="line">        &#125;,</span><br><span class="line">        &apos;info&apos;: &#123;</span><br><span class="line">            &apos;handlers&apos;: [&apos;info&apos;, ],</span><br><span class="line">            &apos;level&apos;: &apos;INFO&apos;,</span><br><span class="line">            &apos;propagate&apos;: True,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line">logger = logging.getLogger(&apos;info&apos;)</span><br><span class="line"></span><br><span class="line">logger.info(&apos;test&apos;)</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[decorator 装饰器]]></title>
      <url>http://yunsonbai.github.io/2016/05/26/decorator/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python的装饰器用途非常多，例如鉴权，重要参数前期验证等等，主要用于在进入方法以前做前期工作，</span><br><span class="line">下边举例针对类方法和函数</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="类方法修饰器"><a href="#类方法修饰器" class="headerlink" title="类方法修饰器"></a>类方法修饰器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from functools import wraps</span><br><span class="line"></span><br><span class="line">def create_user(func):</span><br><span class="line">@wraps(func)</span><br><span class="line">def _warp(self, *args, **kwargs):</span><br><span class="line">        <span class="comment"># 这里写你的方法</span></span><br><span class="line">        pass</span><br><span class="line">        <span class="built_in">return</span> Response(context)</span><br><span class="line">    <span class="built_in">return</span> func(self, *args, **kwargs)</span><br><span class="line"><span class="built_in">return</span> _warp</span><br></pre></td></tr></table></figure>
<h3 id="函数修饰器"><a href="#函数修饰器" class="headerlink" title="函数修饰器"></a>函数修饰器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">和类方法修饰器不通的是没有self</span><br><span class="line">from functools import wraps</span><br><span class="line"></span><br><span class="line">def create_user(func):</span><br><span class="line">@wraps(func)</span><br><span class="line">def _warp(*args, **kwargs):</span><br><span class="line">        <span class="comment"># 这里写你的方法</span></span><br><span class="line">        pass</span><br><span class="line">        <span class="built_in">return</span> Response(context)</span><br><span class="line">    <span class="built_in">return</span> func(*args, **kwargs)</span><br><span class="line"><span class="built_in">return</span> _warp</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[python+mqtt实现推送]]></title>
      <url>http://yunsonbai.github.io/2016/05/24/mqtt-python/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">前段时间趁着空闲时间研究了一下mqtt,自己用python简单的实现了一下,希望日后能用上</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="安装mosquitto并使用命令行"><a href="#安装mosquitto并使用命令行" class="headerlink" title="安装mosquitto并使用命令行"></a>安装mosquitto并使用命令行</h2><h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python2.7</span><br><span class="line">paho-mqtt 1.1</span><br></pre></td></tr></table></figure>
<h3 id="安装安装mosquitto"><a href="#安装安装mosquitto" class="headerlink" title="安装安装mosquitto"></a>安装安装mosquitto</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-add-repository ppa:mosquitto-dev/mosquitto-ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install mosquitto mosquitto-clients python-mosquitto</span><br><span class="line">或者：</span><br><span class="line">     apt-get install mosquitto</span><br></pre></td></tr></table></figure>
<h3 id="安装paho-mqtt"><a href="#安装paho-mqtt" class="headerlink" title="安装paho-mqtt"></a>安装paho-mqtt</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pypi上有这个库，可以自行安装</span><br></pre></td></tr></table></figure>
<h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">启动命令: /usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf</span><br><span class="line">server：mosquitto_pub -t baiyunsong -h 127.0.0.1 -m <span class="string">"&#123;\"pin\":17,\"value\":0&#125;"</span></span><br><span class="line">client：mosquitto_sub -v -t baiyunsong -h 127.0.0.1    （先启动）</span><br></pre></td></tr></table></figure>
<h2 id="python代码"><a href="#python代码" class="headerlink" title="python代码"></a>python代码</h2><h3 id="server端"><a href="#server端" class="headerlink" title="server端"></a>server端</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import paho.mqtt.client as mqtt</span></span><br><span class="line">from paho.mqtt.publish import mqtt</span><br><span class="line">import json</span><br><span class="line">mqttc = mqtt.Client()</span><br><span class="line">mqttc.connect(<span class="string">'127.0.0.1'</span>, port=1883)</span><br><span class="line">msg = &#123;</span><br><span class="line">    <span class="string">'pin'</span>: 17,</span><br><span class="line">    <span class="string">'value'</span>: 10</span><br><span class="line">&#125;</span><br><span class="line">msg = json.dumps(msg)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> mqttc.publish(<span class="string">'baisong'</span>, payload=msg)</span><br><span class="line">mqttc.loop(2)</span><br></pre></td></tr></table></figure>
<h3 id="client-端"><a href="#client-端" class="headerlink" title="client 端"></a>client 端</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line">import paho.mqtt.client as mqtt</span><br><span class="line">import json</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">def on_connect(client, userdata, flags, rc):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Connected with result code '</span> + str(rc))</span><br><span class="line">    client.subscribe(<span class="string">'baisong'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def on_message(client, userdata, msg):</span><br><span class="line">    <span class="built_in">print</span> msg.topic + <span class="string">' '</span> + str(msg.payload)</span><br><span class="line">    <span class="built_in">print</span> json.loads(msg.payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    client = mqtt.Client()</span><br><span class="line">    client.on_connect = on_connect</span><br><span class="line">    client.on_message = on_message</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        client.connect(<span class="string">'127.0.0.1'</span>, port=1883)</span><br><span class="line">        client.loop_forever()</span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        client.disconnect()</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[创建自己的pypi库]]></title>
      <url>http://yunsonbai.github.io/2016/05/23/pypi%E5%BA%93/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在做项目的时候你会发现有好多重复性的工作在做着，如果我们能抽出公共部分的话那样你的工作就会事半功倍，那抽出</span><br><span class="line">来的公共部分就需要存放在自己的pypi库（也不排除你还有其他的办法）</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="搭建服务端"><a href="#搭建服务端" class="headerlink" title="搭建服务端"></a>搭建服务端</h2><h3 id="创建环境"><a href="#创建环境" class="headerlink" title="创建环境"></a>创建环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果你不想混乱自己的环境可以利用virtualenv</span><br><span class="line">virtualenv3.5 pypi</span><br></pre></td></tr></table></figure>
<h3 id="安装需要的库"><a href="#安装需要的库" class="headerlink" title="安装需要的库"></a>安装需要的库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install apache2-utils</span><br><span class="line">pip install pypiserver</span><br><span class="line">pip install passlib</span><br></pre></td></tr></table></figure>
<h3 id="创建packages文件夹和配置文件-htaccess"><a href="#创建packages文件夹和配置文件-htaccess" class="headerlink" title="创建packages文件夹和配置文件.htaccess"></a>创建packages文件夹和配置文件.htaccess</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir packages</span><br><span class="line">htpasswd -sc .htaccess user（之后输入密码，例如123456）</span><br></pre></td></tr></table></figure>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pypi-server -p 3141 -P ./.htaccess ./packages</span><br></pre></td></tr></table></figure>
<h2 id="客户端上传公共库"><a href="#客户端上传公共库" class="headerlink" title="客户端上传公共库"></a>客户端上传公共库</h2><h3 id="在用户根目录下添加配置文件-pypirc"><a href="#在用户根目录下添加配置文件-pypirc" class="headerlink" title="在用户根目录下添加配置文件.pypirc"></a>在用户根目录下添加配置文件.pypirc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">比如你是root用户：</span><br><span class="line">    <span class="built_in">cd</span></span><br><span class="line">    vim .pypirc</span><br><span class="line">    加入内容如下：（distutils处一定要换行）</span><br><span class="line">    [distutils]</span><br><span class="line">    index-servers =</span><br><span class="line">      <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">    [<span class="built_in">local</span>]</span><br><span class="line">    repository:http://xx.xx.xx.xx:3141</span><br><span class="line">    username:user</span><br><span class="line">    password:123456</span><br></pre></td></tr></table></figure>
<h3 id="上传包"><a href="#上传包" class="headerlink" title="上传包"></a>上传包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py sdist upload -r <span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i http://localhost:3134/simple/ some-package</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[对redis命令incr的并发探索]]></title>
      <url>http://yunsonbai.github.io/2016/05/20/redis-incr/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">某个项目想利用redis实现业务锁,比如抽奖只允许被抽中一次, 那么在并发的情况下一定是要锁的,我们用django模</span><br><span class="line">拟每次去redis查询yunson对应的num完后，给num加1</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">双核，三个端口，nginx做代理（每个权重都为一样）</span><br></pre></td></tr></table></figure>
<h3 id="使用hset"><a href="#使用hset" class="headerlink" title="使用hset"></a>使用hset</h3><h4 id="redis数据结构"><a href="#redis数据结构" class="headerlink" title="redis数据结构"></a>redis数据结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yunson---&#123;<span class="string">'num'</span>:100&#125;（json格式）</span><br></pre></td></tr></table></figure>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class MR(APIView):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        REDIS_CONF = &#123;</span><br><span class="line">            <span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">            <span class="string">'port'</span>: 6379,</span><br><span class="line">            <span class="string">'db'</span>: 10,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">''</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        r = redis.Redis(connection_pool=redis.ConnectionPool(**REDIS_CONF))</span><br><span class="line">        yunson = json.loads(r.hget(<span class="string">'test'</span>, <span class="string">'yunson'</span>))</span><br><span class="line">        num = yunson[<span class="string">'num'</span>]</span><br><span class="line">        yunson[<span class="string">'num'</span>] += 1</span><br><span class="line">        yunson = json.dumps(yunson)</span><br><span class="line">        r.hset(<span class="string">'test'</span>, <span class="string">'yunson'</span>, yunson)</span><br><span class="line">        logger = Logger(str(<span class="string">'JS_DJANGO'</span>))</span><br><span class="line">        logger.info(str(num))</span><br><span class="line">        <span class="built_in">return</span> Response(REDIS_CONF)</span><br></pre></td></tr></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -n 1200 -c 400 http://127.0.0.1/mr</span><br></pre></td></tr></table></figure>
<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">This is ApacheBench, Version 2.3 &lt;<span class="variable">$Revision</span>: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 127.0.0.1 (be patient)</span><br><span class="line">Completed 120 requests</span><br><span class="line">Completed 240 requests</span><br><span class="line">Completed 360 requests</span><br><span class="line">Completed 480 requests</span><br><span class="line">Completed 600 requests</span><br><span class="line">Completed 720 requests</span><br><span class="line">Completed 840 requests</span><br><span class="line">Completed 960 requests</span><br><span class="line">Completed 1080 requests</span><br><span class="line">Completed 1200 requests</span><br><span class="line">Finished 1200 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Document Path:          /mr</span><br><span class="line">Document Length:        54 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      400</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   17.807 seconds</span><br><span class="line">Complete requests:      1200</span><br><span class="line">Failed requests:        182</span><br><span class="line">   (Connect: 0, Receive: 0, Length: 182, Exceptions: 0)</span><br><span class="line">Write errors:           0</span><br><span class="line">Non-2xx responses:      182</span><br><span class="line">Total transferred:      324848 bytes</span><br><span class="line">HTML transferred:       86458 bytes</span><br><span class="line">Requests per second:    67.39 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       5935.669 [ms] (mean)</span><br><span class="line">Time per request:       14.839 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          17.82 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis结果：</span><br><span class="line">    &#123;<span class="string">"num"</span>: 616&#125;  差出：1200-182-616 = 402   </span><br><span class="line">    打日志时：根据日志分析发现除服率相当高上大几十（当然没看全，一看这样头就大</span><br><span class="line">    (你咋算的：</span><br><span class="line">        Complete requests:      1200</span><br><span class="line">        Failed requests:        182)</span><br></pre></td></tr></table></figure>
<h3 id="优化使用incr"><a href="#优化使用incr" class="headerlink" title="优化使用incr"></a>优化使用incr</h3><h4 id="redis数据结构-1"><a href="#redis数据结构-1" class="headerlink" title="redis数据结构"></a>redis数据结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yunson---0</span><br></pre></td></tr></table></figure>
<h4 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class MR(APIView):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        REDIS_CONF = &#123;</span><br><span class="line">            <span class="string">'host'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">            <span class="string">'port'</span>: 6379,</span><br><span class="line">            <span class="string">'db'</span>: 10,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">''</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        r = redis.Redis(connection_pool=redis.ConnectionPool(**REDIS_CONF))</span><br><span class="line">        try:</span><br><span class="line">            logger = Logger(str(<span class="string">'JS_DJANGO'</span>))</span><br><span class="line">            <span class="keyword">if</span> not r.get(<span class="string">'yunson'</span>):</span><br><span class="line">                yunson = r.incr(<span class="string">'yunson'</span>)</span><br><span class="line">                r.set(<span class="string">'yunson '</span>, yunson , ex=60)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                yunson= r.incr(<span class="string">'baisong'</span>)</span><br><span class="line">            logger.info(str(yunson))</span><br><span class="line">        except Exception, e:</span><br><span class="line">            <span class="built_in">print</span> Exception, e</span><br><span class="line">        <span class="built_in">return</span> Response(REDIS_CONF)</span><br></pre></td></tr></table></figure>
<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -n 1200 -c 400 http://127.0.0.1/mr</span><br></pre></td></tr></table></figure>
<h4 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">This is ApacheBench, Version 2.3 &lt;<span class="variable">$Revision</span>: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 127.0.0.1 (be patient)</span><br><span class="line">Completed 120 requests</span><br><span class="line">Completed 240 requests</span><br><span class="line">Completed 360 requests</span><br><span class="line">Completed 480 requests</span><br><span class="line">Completed 600 requests</span><br><span class="line">Completed 720 requests</span><br><span class="line">Completed 840 requests</span><br><span class="line">Completed 960 requests</span><br><span class="line">Completed 1080 requests</span><br><span class="line">Completed 1200 requests</span><br><span class="line">Finished 1200 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.1.19</span><br><span class="line">Server Hostname:        127.0.0.1</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /mr</span><br><span class="line">Document Length:        54 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      400</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   17.311 seconds</span><br><span class="line">Complete requests:      1200</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      313200 bytes</span><br><span class="line">HTML transferred:       64800 bytes</span><br><span class="line">Requests per second:    69.32 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       5770.450 [ms] (mean)</span><br><span class="line">Time per request:       14.426 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          17.67 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">redis结果：</span><br><span class="line">    yunson---1200</span><br><span class="line">    分毫不差</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在业务逻辑控制锁的时候，尤其是在并发的时候可以考虑利用redis的这个机制，当然用数据库</span><br><span class="line">的锁也可以（同时数据库的锁更为灵活），但是如果只是类似于这种计数机制，可以尝试用redis</span><br><span class="line">毕竟redis是操作内存，速度上要快些</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[python2到3项目迁移]]></title>
      <url>http://yunsonbai.github.io/2016/05/20/python2%E5%88%B03/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">目前项目组逐步将项目迁移到python3，下边说一下在迁移的过程中遇到的一些问题和注意事项</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="安装python3"><a href="#安装python3" class="headerlink" title="安装python3"></a>安装python3</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">起初我采用的是如下编译方式：</span><br><span class="line">    $ ./configure --prefix=/usr/<span class="built_in">local</span>/python3.5/</span><br><span class="line">    make install</span><br><span class="line">好景不长，收到了如下错误：</span><br><span class="line">    $ No module named _sqlite3</span><br><span class="line">解决办法：</span><br><span class="line">    $ yum -y install sqlite-devel</span><br><span class="line">    $ ./configure --enable-loadable-sqlite-extensions --prefix=/usr/<span class="built_in">local</span>/python3.5/</span><br><span class="line">    $ make install</span><br></pre></td></tr></table></figure>
<h2 id="迁移中需要注意的点"><a href="#迁移中需要注意的点" class="headerlink" title="迁移中需要注意的点"></a>迁移中需要注意的点</h2><h3 id="urllib2改变"><a href="#urllib2改变" class="headerlink" title="urllib2改变"></a>urllib2改变</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python2.7：</span><br><span class="line">    avatar_img = urllib2.urlopen(avatar_url).read()</span><br><span class="line">python3.5：</span><br><span class="line">    import urllib.request</span><br><span class="line">    avatar_img = urllib.request.urlopen(avatar_url).read()</span><br></pre></td></tr></table></figure>
<h3 id="redis配置改变"><a href="#redis配置改变" class="headerlink" title="redis配置改变"></a>redis配置改变</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">redis_conf = &#123;</span><br><span class="line">    <span class="string">'host'</span>: ip,</span><br><span class="line">    <span class="string">'port'</span>: port,</span><br><span class="line">    <span class="string">'db'</span>: 1,</span><br><span class="line">    <span class="string">'password'</span>: password,</span><br><span class="line">    <span class="string">'socket_timeout'</span>: None,</span><br><span class="line">    <span class="string">'encoding'</span>: <span class="string">'utf-8'</span>,</span><br><span class="line">    <span class="string">'encoding_errors'</span>: <span class="string">'strict'</span>,</span><br><span class="line">    <span class="string">'decode_responses'</span>: True    此处要注意</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CStringIO与StringIO不能再用"><a href="#CStringIO与StringIO不能再用" class="headerlink" title="CStringIO与StringIO不能再用"></a>CStringIO与StringIO不能再用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">io.BytesIO</span><br><span class="line">io.StringIO</span><br></pre></td></tr></table></figure>
<h3 id="try和except的改变"><a href="#try和except的改变" class="headerlink" title="try和except的改变"></a>try和except的改变</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">python2.7：</span><br><span class="line">    try:</span><br><span class="line">        pass</span><br><span class="line">    except Exception, e:</span><br><span class="line">        pass</span><br><span class="line">python3.5:</span><br><span class="line">    try：</span><br><span class="line">        pass</span><br><span class="line">    except Exception as e:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<h3 id="默认Image取消"><a href="#默认Image取消" class="headerlink" title="默认Image取消"></a>默认Image取消</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python2.7：</span><br><span class="line">    支持：import Image</span><br><span class="line">python3.5：</span><br><span class="line">    pip3.5 install Pillow</span><br><span class="line">    from PIL import Image</span><br></pre></td></tr></table></figure>
<h3 id="hash操作必须encode"><a href="#hash操作必须encode" class="headerlink" title="hash操作必须encode"></a>hash操作必须encode</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sig_str = sig_string + appkey</span><br><span class="line">sig_str = sig_str.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">sig_md5 = hashlib.md5()</span><br><span class="line">sig_md5.update(sig_str)</span><br></pre></td></tr></table></figure>
<h3 id="xrange取消"><a href="#xrange取消" class="headerlink" title="xrange取消"></a>xrange取消</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由range代替</span><br></pre></td></tr></table></figure>
<h3 id="startwith第一个参数必须是bytes或者bytes组成的tuple"><a href="#startwith第一个参数必须是bytes或者bytes组成的tuple" class="headerlink" title="startwith第一个参数必须是bytes或者bytes组成的tuple"></a>startwith第一个参数必须是bytes或者bytes组成的tuple</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startwith(b&apos;GIF89&apos;)(python3.5强制加b)</span><br></pre></td></tr></table></figure>
<h3 id="raw-input-改成input"><a href="#raw-input-改成input" class="headerlink" title="raw_input()改成input()"></a>raw_input()改成input()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python2.7：</span><br><span class="line">    a = raw_input(input a:)</span><br><span class="line">python3.5:</span><br><span class="line">    a = input(&apos;input a:&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="有人可能用supervisor"><a href="#有人可能用supervisor" class="headerlink" title="有人可能用supervisor"></a>有人可能用supervisor</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">目前supervisor不支持python3，</span><br><span class="line">但是git上已久supervisor4，支持python3，</span><br><span class="line">我想不就得将来supervisor马上也就能在python3上使用了</span><br></pre></td></tr></table></figure>
<h3 id="python与yum"><a href="#python与yum" class="headerlink" title="python与yum"></a>python与yum</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">建议不要将python3软连在/usr/bin/python上，这样有可能导</span><br><span class="line">yum不能使用，</span><br><span class="line">如果非要这样软连，你需要修改：</span><br><span class="line">/usr/bin/yum</span><br><span class="line">    #!/usr/bin/python</span><br><span class="line">    改成：</span><br><span class="line">    #!/usr/bin/python2.7</span><br></pre></td></tr></table></figure>
<h3 id="提示bytes-like-object-is-required-not-‘str’"><a href="#提示bytes-like-object-is-required-not-‘str’" class="headerlink" title="提示bytes-like object is required, not ‘str’"></a>提示bytes-like object is required, not ‘str’</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">解决办法：</span><br><span class="line">    1、加b</span><br><span class="line">    2、encode(&apos;utf-8&apos;)</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[git常用命令]]></title>
      <url>http://yunsonbai.github.io/2016/05/19/git/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git可以说已经渗入到大部分互联网企业,下边记录一下在工作的这段时间用到的命令</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="删除远程分支"><a href="#删除远程分支" class="headerlink" title="删除远程分支"></a>删除远程分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch -r <span class="_">-d</span> origin/branch-name</span><br><span class="line">git push origin :branch-name</span><br></pre></td></tr></table></figure>
<h3 id="创建本地-push到远端分支"><a href="#创建本地-push到远端分支" class="headerlink" title="创建本地/push到远端分支"></a>创建本地/push到远端分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git branch dev</span><br><span class="line">git checkout dev</span><br><span class="line">git push origin dev</span><br></pre></td></tr></table></figure>
<h3 id="删除本地分支"><a href="#删除本地分支" class="headerlink" title="删除本地分支"></a>删除本地分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git branch 分支名称 <span class="_">-d</span></span><br><span class="line">例如，在master分支下，删除新开的dev分支：</span><br><span class="line">git branch dev <span class="_">-d</span></span><br><span class="line">注意：如果dev的更改，push到远程，在GitLab(或者其他git系统)上面进行了merge操作，但是本地master没有pull最新的代码，会删除不成功，可以先git pull origin master，或者强制删除</span><br><span class="line">git branch dev -D</span><br></pre></td></tr></table></figure>
<h3 id="创建tag号并push到远端"><a href="#创建tag号并push到远端" class="headerlink" title="创建tag号并push到远端"></a>创建tag号并push到远端</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git tag <span class="_">-a</span> v1.01 -m <span class="string">"Relase version 1.01"</span></span><br><span class="line">git push origin -tags(提交全部tag)</span><br><span class="line">或者：</span><br><span class="line">git tag <span class="_">-a</span> v1.01 -m <span class="string">"Relase version 1.01"</span></span><br><span class="line">git push origin v1.01</span><br></pre></td></tr></table></figure>
<h3 id="删除远端tag号"><a href="#删除远端tag号" class="headerlink" title="删除远端tag号"></a>删除远端tag号</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git tag <span class="_">-d</span> v1.01</span><br><span class="line">git push origin :refs/tags/v1.01</span><br></pre></td></tr></table></figure>
<h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git merge 需要合并的分支名</span><br><span class="line">例如，刚刚已经切换回master，现在需要合并dev的内容：</span><br><span class="line">git merge dev</span><br><span class="line">建议在GitLab(或者其他git系统)上面创建merge request的形式来进行分支的合并和代码审核</span><br></pre></td></tr></table></figure>
<h3 id="status"><a href="#status" class="headerlink" title="status"></a>status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看发生变动的文件</span><br><span class="line">git status</span><br></pre></td></tr></table></figure>
<h3 id="与远程保持同步"><a href="#与远程保持同步" class="headerlink" title="与远程保持同步"></a>与远程保持同步</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git fetch origin</span><br><span class="line">git rebase origin/master</span><br></pre></td></tr></table></figure>
<h3 id="追踪远程分支"><a href="#追踪远程分支" class="headerlink" title="追踪远程分支"></a>追踪远程分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -vv</span><br></pre></td></tr></table></figure>
<h3 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard f46821f94eeb106ea841b9fbafa4bfb76beea691 </span><br><span class="line">(f46821f94eeb106ea841b9fbafa4bfb76beea691为commit编号)</span><br></pre></td></tr></table></figure>
<h3 id="查看commit编号"><a href="#查看commit编号" class="headerlink" title="查看commit编号"></a>查看commit编号</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log</span><br></pre></td></tr></table></figure>
<h3 id="显示不通"><a href="#显示不通" class="headerlink" title="显示不通"></a>显示不通</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git diff  全部的改动，包括没有add的</span><br><span class="line">git diff --stage   显示add的，</span><br><span class="line">git diff  commit1 commit2  （显示两次的不通，输入commit号）</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[hexo命令]]></title>
      <url>http://yunsonbai.github.io/2016/05/12/hexo%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">记录了一下hexo常用的命令, 在维护个人博客的时候经常会用到</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<h3 id="Insert-image"><a href="#Insert-image" class="headerlink" title="Insert image"></a>Insert image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% img [class names] /path/to/image [width] [height] [title text [alt text]] %&#125;</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[fiddler代理利器]]></title>
      <url>http://yunsonbai.github.io/2016/05/12/fiddler/</url>
      <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fiddler在前端开发工程师那可以说是利器,同样后端工程师也可能用到尤其是在利用app调试api的时候，</span><br><span class="line">也许你就会用到fiddler</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="只代理某个url"><a href="#只代理某个url" class="headerlink" title="只代理某个url"></a>只代理某个url</h3><h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">比如把线上某个url代理到本地/或者调试某个接口,便于调试</span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">点击AotuResponder,之后把三个复选框全选上,然后点击add ruler</span><br><span class="line">加入:</span><br><span class="line">    regex:.*yunsonbai.com /activity/(.*)</span><br><span class="line">    http://127.0.0.1:8000/activity/<span class="variable">$1</span></span><br></pre></td></tr></table></figure>
<h3 id="设置host"><a href="#设置host" class="headerlink" title="设置host"></a>设置host</h3><h4 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">把某个域全部代理到本地</span><br></pre></td></tr></table></figure>
<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">点击Tools-&gt;HOSTS-&gt;选上复选框</span><br><span class="line">加入:</span><br><span class="line">    127.0.0.1:8000 yunsonbai.com</span><br></pre></td></tr></table></figure>
<h3 id="如何让手机也走设置好的代理"><a href="#如何让手机也走设置好的代理" class="headerlink" title="如何让手机也走设置好的代理"></a>如何让手机也走设置好的代理</h3><h4 id="应用-2"><a href="#应用-2" class="headerlink" title="应用"></a>应用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">调试移动端应用</span><br></pre></td></tr></table></figure>
<h4 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">设置wifi代理为手动；</span><br><span class="line">servername: 你电脑的ip/或域名</span><br><span class="line">port: 8888（fiddler默认是启动8888端口）</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://www.telerik.com/fiddler" target="_blank" rel="external">Generating</a></p>
]]></content>
    </entry>
    
  
  
</search>
