<!DOCTYPE html>
<!-- saved from url=(0011)about:blank -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style type="text/css">body{font-family:sans-serif;}</style><link rel="stylesheet" type="text/css" href="https://res.wx.qq.com/mpres/zh_CN/htmledition/comm_htmledition/style/widget/ueditor_new/themes/iframe4b4fb7.css"><style id="checktext">mpchecktext,mptmpchecktext{display:none;}</style><style id="table">.selectTdClass{background-color:#edf5fa !important}table.noBorderTable td,table.noBorderTable th,table.noBorderTable caption{border:1px dashed #ddd !important}table{margin-bottom:10px;border-collapse:collapse;display:table;}td,th{padding: 5px 10px;border: 1px solid #DDD;}caption{border:1px dashed #DDD;border-bottom:0;padding:3px;text-align:center;}th{border-top:2px solid #BBB;background:#F7F7F7;}.ue-table-interlace-color-single{ background-color: #fcfcfc; } .ue-table-interlace-color-double{ background-color: #f7faff; }td p{margin:0;padding:0;}</style><style id="list">ol,ul{margin:0;padding:0;-webkit-box-sizing:border-box;box-sizing:border-box;width:99.9%}li{clear:both;}.list-paddingleft-1{padding-left:1.2em}
.list-paddingleft-2{padding-left:2.2em}
.list-paddingleft-3{padding-left:3.2em}</style></head><body class="view" lang="en" contenteditable="true" spellcheck="false" style="overflow-y: hidden; cursor: text; height: 5920px;"><h2 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.45em; border-bottom: 1px solid rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">引言<mpchecktext contenteditable="false" id="1580626918779_0.2284044827816245"></mpchecktext></h2><p style="margin-bottom: 20px; color: rgb(85, 85, 85); font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 14px; white-space: normal; background-color: rgb(255, 255, 255);">我的博客：<mpchecktext contenteditable="false" id="1580626918780_0.6171868175754962"></mpchecktext>http://yunsonbai.top<mpchecktext contenteditable="false" id="1580626918781_0.33214282360927316"></mpchecktext></p><pre style="padding: 10px;color: rgb(77, 77, 76);font-size: 14px;text-align: left;overflow: auto;font-family: consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;background: rgb(247, 247, 247);line-height: 1.6;border-width: initial;border-style: none;border-color: initial;width: 650px;"><p><span style="height: 20px;">随着业务的发展，为了满足越来越多的任务，逐渐从原来的单机到多机再到基于docker</span><span style="height: 20px;">的</span><span style="height: 20px;">集</span><span style="height: 20px;">群，发展</span>到集群会带来新的问题需要解决，比如日志散落在各个实例上，对于日志的统计分析带来了新的要求，一台一台的去查显然是不合理的，这就引出本文讨论的主题:<mpchecktext contenteditable="false" id="1580626918782_0.821514142077143"></mpchecktext></p><p>分布式日志收集。<mpchecktext contenteditable="false" id="1580626918783_0.8146365097596295"></mpchecktext></p></pre><p><br></p><h2 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.45em; border-bottom: 1px solid rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">简单介绍一下用到的组件/工具<mpchecktext contenteditable="false" id="1580626918784_0.7140103224876713"></mpchecktext></h2><h3 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.3em; border-bottom: 1px dotted rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">filebeat<mpchecktext contenteditable="false" id="1580626918785_0.1256659358895309"></mpchecktext></h3><ul style="" class=" list-paddingleft-2"><li><p>文档:&nbsp;<mpchecktext contenteditable="false" id="1580626918786_0.3202063772396646"></mpchecktext></p><p>https://www.elastic.co/cn/beats/filebeat<mpchecktext contenteditable="false" id="1580626918787_0.4013708937321341"></mpchecktext></p><p>我觉得这里边已经说的很清楚为啥使用filebeat做日志收集器了<mpchecktext contenteditable="false" id="1580626918788_0.0031173489794744658"></mpchecktext></p></li><li><p>优势:<mpchecktext contenteditable="false" id="1580626918789_0.20719639352787933"></mpchecktext></p></li><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p>基于golang的轻量级日志采集器，配置启动出奇的简单<mpchecktext contenteditable="false" id="1580626918790_0.14541853265224347"></mpchecktext></p></li><li><p>按官方说法elastic专门为成千上万机器日志收集做的收集器<mpchecktext contenteditable="false" id="1580626918791_0.07126879787813722"></mpchecktext></p></li></ul></ul><h3 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.3em; border-bottom: 1px dotted rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">kafka<mpchecktext contenteditable="false" id="1580626918792_0.03474226588207219"></mpchecktext></h3><ul style="" class=" list-paddingleft-2"><li><p>文档:&nbsp;https://kafka.apache.org/<mpchecktext contenteditable="false" id="1580626918793_0.29306785103837063"></mpchecktext></p></li><li><p>优势:<mpchecktext contenteditable="false" id="1580626918794_0.9876413043613059"></mpchecktext></p></li><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p>应该说kafka的诞生就是为日志收集做服务的<mpchecktext contenteditable="false" id="1580626918795_0.8750671557287193"></mpchecktext></p></li><li><p>几乎可以认为kafka集群没有qps上限，单机都能到10W/s的吞吐，完全分布式。<mpchecktext contenteditable="false" id="1580626918796_0.8529973954654084"></mpchecktext>[可怕]<mpchecktext contenteditable="false" id="1580626918797_0.78721045882581"></mpchecktext></p></li><li><p>好文推荐:&nbsp;https://www.infoq.cn/article/kafka-analysis-part-1<mpchecktext contenteditable="false" id="1580626918798_0.31124321951435996"></mpchecktext></p></li></ul></ul><h3 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.3em; border-bottom: 1px dotted rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">ELK<mpchecktext contenteditable="false" id="1580626918799_0.7841117747901958"></mpchecktext></h3><ul style="" class=" list-paddingleft-2"><li><p>E: ElasticSearch<mpchecktext contenteditable="false" id="1580626918800_0.9960091681788967"></mpchecktext></p></li><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p>文档:&nbsp;<mpchecktext contenteditable="false" id="1580626918801_0.136468539331825"></mpchecktext></p><p>https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html<mpchecktext contenteditable="false" id="1580626918802_0.08945307645607614"></mpchecktext></p></li><li><p>优势: 高度可扩展的开源全文搜索和分析引擎，可快速、实时存储、搜索和分析数据。<mpchecktext contenteditable="false" id="1580626918803_0.028703355843389344"></mpchecktext>(网上太多了)<mpchecktext contenteditable="false" id="1580626918804_0.8089679324329109"></mpchecktext></p></li><li><p>好文推荐:&nbsp;https://juejin.im/entry/5bef7046e51d4557fe34e812<mpchecktext contenteditable="false" id="1580626918857_0.9625012804163395"></mpchecktext>​</p><p><br></p></li></ul><li><p style="margin-bottom: 20px;">L: Logstash<mpchecktext contenteditable="false" id="1580626918858_0.6183978542950903"></mpchecktext></p></li><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p>文档:&nbsp;https://www.elastic.co/cn/products/logstash<mpchecktext contenteditable="false" id="1580626918807_0.17665118987001138"></mpchecktext></p></li><li><p>优势: 实时流水线功能，分析合并来源(MySQL、Redis、kafka)数据，并输出到目标(es、file等)存储地址<mpchecktext contenteditable="false" id="1580626918808_0.014343663511495075"></mpchecktext></p></li><li><p>好文推荐:&nbsp;上手Logstash<mpchecktext contenteditable="false" id="1580626918809_0.593372669744608"></mpchecktext></p></li></ul><li><p style="margin-bottom: 20px;">K: kibana<mpchecktext contenteditable="false" id="1580626918810_0.947938966985312"></mpchecktext></p></li><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p>文档:&nbsp;https://www.elastic.co/cn/products/kibana<mpchecktext contenteditable="false" id="1580626918811_0.41216493248239217"></mpchecktext></p></li><li><p>优势: 完备的前端展示<mpchecktext contenteditable="false" id="1580626918812_0.3262473087147042"></mpchecktext></p></li></ul></ul><h3 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.3em; border-bottom: 1px dotted rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">grafana<mpchecktext contenteditable="false" id="1580626918813_0.40266387028477"></mpchecktext></h3><ul style="" class=" list-paddingleft-2"><li><p>是什么: 可以理解和kibana一样的东西，出于个人的喜爱，它真的很黑炫酷<mpchecktext contenteditable="false" id="1580626918814_0.013349201520747034"></mpchecktext></p></li><li><p>文档:&nbsp;https://grafana.com/<mpchecktext contenteditable="false" id="1580626918815_0.4367910677967257"></mpchecktext></p></li></ul><h3 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.3em; border-bottom: 1px dotted rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">其他说明<mpchecktext contenteditable="false" id="1580626918816_0.9805991163956169"></mpchecktext></h3><pre style="padding: 10px;color: rgb(77, 77, 76);font-size: 14px;text-align: left;overflow: auto;font-family: consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;background: rgb(247, 247, 247);line-height: 1.6;border-width: initial;border-style: none;border-color: initial;width: 706px;"><p><span style="height: 20px;">其实没有花太多篇幅介绍上边的组件的使用和原理，本文的分享重点不在这里，只是分享用</span><span style="height: 20px;">什么样的架构来使用</span>这些组件，关于这些组件的原理和使用我分享了几篇好文章以及官方文档，大家可以参考，另外网上这种介绍文章很多，接下来分享我的目前日志量和收集架构<mpchecktext contenteditable="false" id="1580626918817_0.18172010516808323"></mpchecktext></p></pre><h2 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.45em; border-bottom: 1px solid rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">架构情况说明<mpchecktext contenteditable="false" id="1580626918818_0.6122820718215962"></mpchecktext></h2><ul style="" class=" list-paddingleft-2"><li><p>架构图:<mpchecktext contenteditable="false" id="1580626918819_0.09630783396330522"></mpchecktext></p></li></ul><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.4509151414309484" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/e0gxoK2icBHGXmNGpEIKXQVHRIH9E5z6vPFpbV0CN9EHauZseldSRIvh3xrDB9Yn7aOdibcdM4nKu3SgeF9byNTQ/640?wx_fmt=png" data-type="png" data-w="1202" style=""></p><p><br></p><ul style="" class=" list-paddingleft-2"><li><p>实例数: 全部基于docker部署，各类角色的实例数过千<mpchecktext contenteditable="false" id="1580626918820_0.038219041107132146"></mpchecktext></p></li><li><p>日志量: 日均日志约4.6亿条, 占空间约140G。<mpchecktext contenteditable="false" id="1580626918821_0.24571885891872558"></mpchecktext></p></li><li><p>目前收集架构负载: 十几个es节点个位数负载，个位数个logstash节点也几乎没有负载。<mpchecktext contenteditable="false" id="1580626918822_0.0946840267042326"></mpchecktext></p></li><li><p>版本说明: filebeat、logstash、es、kibana版本要一致<mpchecktext contenteditable="false" id="1580626918823_0.6507217289471925"></mpchecktext></p></li></ul><h3 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.3em; border-bottom: 1px dotted rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">组件使用注意点<mpchecktext contenteditable="false" id="1580626918824_0.5212959329864781"></mpchecktext></h3><h4 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.2em; color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">filebeat<mpchecktext contenteditable="false" id="1580626918825_0.6560457367824715"></mpchecktext></h4><pre style="padding: 10px;color: rgb(77, 77, 76);font-size: 14px;text-align: left;overflow: auto;font-family: consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;background: rgb(247, 247, 247);line-height: 1.6;border-width: initial;border-style: none;border-color: initial;width: 706px;"><p><span style="height: 20px;"></span>打包说明:&nbsp;<span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">镜像在打包时，要添加上filebeat可执行文件(可在官网下载)，可以使用</span><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">supervisor管理服务。<mpchecktext contenteditable="false" id="1580626918826_0.857320425086896"></mpchecktext></span></p></pre><p><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"></span></p><p>filebeat配置文件可参考以下例子:<mpchecktext contenteditable="false" id="1580626918827_0.6122642607490667"></mpchecktext></p><pre class="code-snippet__js code-snippet code-snippet_nowrap" data-lang="properties"><code><span class="code-snippet_outer"><span class="code-snippet__meta">filebeat.prospectors</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__meta">-</span> <span class="code-snippet__string">input_type: log</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">paths</span>: <span class="code-snippet__string">/var/log/nginx.log</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">document_type</span>: <span class="code-snippet__string">nginx_log</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">fields</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">cluster_name</span>: <span class="code-snippet__string">${CLUSTER_NAME}</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">host</span>: <span class="code-snippet__string">${HOST}</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">log_topics</span>: <span class="code-snippet__string">app1_nginx  # nginx日志<mpchecktext contenteditable="false" id="1580626918828_0.6337035773290596"></mpchecktext></span></span></code><code><span class="code-snippet_outer">​</span></code><code><span class="code-snippet_outer"><span class="code-snippet__meta">-</span> <span class="code-snippet__string">input_type: log</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">paths</span>: <span class="code-snippet__string">/var/applog/*.log</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">document_type</span>: <span class="code-snippet__string">applog</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">fields</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">cluster_name</span>: <span class="code-snippet__string">${CLUSTER_NAME}</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">host</span>: <span class="code-snippet__string">${HOST}</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">log_topics</span>: <span class="code-snippet__string">app1_log  # 应用日志<mpchecktext contenteditable="false" id="1580626918829_0.47375217441175654"></mpchecktext></span></span></code><code><span class="code-snippet_outer">​</span></code><code><span class="code-snippet_outer"><span class="code-snippet__meta">output.kafka</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">hosts</span>: <span class="code-snippet__string">["kafka1:9092","kafka2:9092",...,"kafkaN:9092"]<mpchecktext contenteditable="false" id="1580626918830_0.941168686167122"></mpchecktext></span></span></code><code><span class="code-snippet_outer">​</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">topic</span>: <span class="code-snippet__string">'%{[fields][log_topics]}'</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__meta">partition.round_robin</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">reachable_only</span>: <span class="code-snippet__string">false</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">required_acks</span>: <span class="code-snippet__string">1</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">compression</span>: <span class="code-snippet__string">gzip<mpchecktext contenteditable="false" id="1580626918831_0.21216198797588426"></mpchecktext></span></span></code></pre><h4 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.2em; color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">logstash<mpchecktext contenteditable="false" id="1580626918832_0.34932871153734824"></mpchecktext></h4><ul style="" class=" list-paddingleft-2"><li><p>机器数量: 可以找几台虚机(4c+8G)启动，个数和kafka的节点数一致。<mpchecktext contenteditable="false" id="1580626918833_0.14561823498422188"></mpchecktext></p></li><li><p>input和output: kafka(filebeat日志流向的kafka)和es集群<mpchecktext contenteditable="false" id="1580626918834_0.5460141859603904"></mpchecktext></p></li><li><p style="margin-bottom: 20px;"><strong>配置注意<mpchecktext contenteditable="false" id="1580626918835_0.29231892727983544"></mpchecktext></strong></p></li><section style="margin-bottom: 20px; line-height: normal;"><strong>pipeline.batch.size: 2000&nbsp; # 达到多少events后向目标地址输送数据<mpchecktext contenteditable="false" id="1580626918836_0.33707458867884244"></mpchecktext></strong></section><section style="margin-bottom: 20px; line-height: normal;"><strong>pipeline.batch.delay: 10&nbsp; &nbsp;# 等待多少秒向目标地址输送数据<mpchecktext contenteditable="false" id="1580626918837_0.7453090708358017"></mpchecktext></strong></section><li><p style="margin-bottom: 20px;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">关于filter<mpchecktext contenteditable="false" id="1580626918838_0.22037658883524802"></mpchecktext></span></p><p style="margin-bottom: 20px;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">一般会用到的有grok(正则切割日志)、json(json解析)</span><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">、mutate(组合命令remove_field(去除无用字段)等等)</span><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">很多这里不一一介绍了，推荐一个可以在线测试grok语法是否正确的工具:http://grokdebug.herokuapp.com/<mpchecktext contenteditable="false" id="1580626918839_0.904285357263628"></mpchecktext></span></p></li><li><p style="margin-bottom: 20px;">配置样例<mpchecktext contenteditable="false" id="1580626918840_0.3008513862831339"></mpchecktext></p></li></ul><pre class="code-snippet__js code-snippet code-snippet_nowrap" data-lang="php"><code><span class="code-snippet_outer">input {</span></code><code><span class="code-snippet_outer">    kafka{</span></code><code><span class="code-snippet_outer">        bootstrap_servers =&gt; <span class="code-snippet__string">"kafka1:9092,kafka2:9092,...,kafkaN:9092"</span> <span class="code-snippet__comment"># 前边的kafka</span></span></code><code><span class="code-snippet_outer">        auto_offset_reset =&gt; <span class="code-snippet__string">"latest"</span></span></code><code><span class="code-snippet_outer">        group_id =&gt; <span class="code-snippet__string">"app1"</span> </span></code><code><span class="code-snippet_outer">        consumer_threads =&gt; <span class="code-snippet__number">1</span></span></code><code><span class="code-snippet_outer">        decorate_events =&gt; <span class="code-snippet__keyword">true</span></span></code><code><span class="code-snippet_outer">        codec =&gt; <span class="code-snippet__string">"json"</span></span></code><code><span class="code-snippet_outer">        topics =&gt; [<span class="code-snippet__string">"app1_log"</span>]</span></code><code><span class="code-snippet_outer">    }</span></code><code><span class="code-snippet_outer">}</span></code><code><span class="code-snippet_outer">filter {</span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">if</span> [fields][log_topics] == <span class="code-snippet__string">"app1_log"</span> {</span></code><code><span class="code-snippet_outer">        grok {</span></code><code><span class="code-snippet_outer">            match =&gt; {<span class="code-snippet__string">"message"</span> =&gt; <span class="code-snippet__string">'(?&lt;time_local&gt;[^\|]*)\|(?&lt;code_line&gt;[^\|]*)\|(?&lt;level&gt;[^\|]*)\|(?&lt;log_json&gt;.*)'</span>}</span></code><code><span class="code-snippet_outer">        }</span></code><code><span class="code-snippet_outer">        mutate {</span></code><code><span class="code-snippet_outer">            gsub =&gt; [<span class="code-snippet__string">"log_json"</span>, <span class="code-snippet__string">"[\|]"</span>, <span class="code-snippet__string">"_"</span>]  <span class="code-snippet__comment"># 替换|为_</span></span></code><code><span class="code-snippet_outer">        }</span></code><code><span class="code-snippet_outer">        json {</span></code><code><span class="code-snippet_outer">            source =&gt; <span class="code-snippet__string">"log_json"</span></span></code><code><span class="code-snippet_outer">            remove_field=&gt;[<span class="code-snippet__string">"log_json"</span>]</span></code><code><span class="code-snippet_outer">        }</span></code><code><span class="code-snippet_outer">    }</span></code><code><span class="code-snippet_outer">    <span class="code-snippet__comment"># 可以有多个if</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__comment"># remove not care field</span></span></code><code><span class="code-snippet_outer">    mutate</span></code><code><span class="code-snippet_outer">    {</span></code><code><span class="code-snippet_outer">        remove_field =&gt; [<span class="code-snippet__string">"field1"</span>, <span class="code-snippet__string">"field2"</span>]</span></code><code><span class="code-snippet_outer">    }</span></code><code><span class="code-snippet_outer">}</span></code><code><span class="code-snippet_outer">output {</span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">if</span> [fields][log_topics] == <span class="code-snippet__string">"app1_log"</span> {</span></code><code><span class="code-snippet_outer">        elasticsearch {</span></code><code><span class="code-snippet_outer">             hosts =&gt; [<span class="code-snippet__string">"es1:9200"</span>, <span class="code-snippet__string">"es2:9200"</span>,..,<span class="code-snippet__string">"esN:9200"</span>]</span></code><code><span class="code-snippet_outer">            index =&gt; <span class="code-snippet__string">"app1_log-%{+YYYY.MM.dd}"</span></span></code><code><span class="code-snippet_outer">        }</span></code><code><span class="code-snippet_outer">    }</span></code><code><span class="code-snippet_outer">    <span class="code-snippet__comment"># 可以有多个if</span></span></code><code><span class="code-snippet_outer">}<mpchecktext contenteditable="false" id="1580626918841_0.9828667730692331"></mpchecktext></span></code></pre><h4 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.2em; color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">关于es<mpchecktext contenteditable="false" id="1580626918842_0.1214367940839387"></mpchecktext></h4><pre style="padding: 10px;color: rgb(77, 77, 76);text-align: left;overflow: auto;font-family: consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace;background: rgb(247, 247, 247);line-height: 1.6;border-width: initial;border-style: none;border-color: initial;width: 648px;"><p><span style="height: 20px;"><strong style="white-space: normal;">注意修改number_of_shards数量等于节点数，es的number_of_shards</strong></span><strong style="white-space: normal;">默认为5，</strong>跳过一次坑，没有修改number_of_shards，虽然机器多，但是<span style="height: 20px;">日志散落</span><span style="height: 20px;">不均匀导致总有es的某几个</span>节点负载比较高，其他的却很清闲。<mpchecktext contenteditable="false" id="1580626918843_0.4276211904138174"></mpchecktext></p></pre><h4 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.2em; color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">关于数据展示<mpchecktext contenteditable="false" id="1580626918844_0.27283063145100783"></mpchecktext><br></h4><ul style="" class=" list-paddingleft-2"><li><p>kibana:一张老图<mpchecktext contenteditable="false" id="1580626918845_0.21655525258496056"></mpchecktext><br></p></li></ul><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.7360655737704918" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/e0gxoK2icBHGXmNGpEIKXQVHRIH9E5z6vsW0OZFJ73eO4WyMufuiaoW5gwTPh1LCEiajPrMCU6FbPtnT7kY9IRVEw/640?wx_fmt=png" data-type="png" data-w="1220" style=""></p><ul style="" class=" list-paddingleft-2"><li><p style="margin-bottom: 20px;">grafana<mpchecktext contenteditable="false" id="1580626918846_0.4592105183528119"></mpchecktext><br></p></li></ul><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.61328125" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/e0gxoK2icBHGXmNGpEIKXQVHRIH9E5z6vfLkLqFlPBc5BVVr6HaCpMTvkEuXaFVQvl4Nknl9Kzh6t6L39VFptGg/640?wx_fmt=png" data-type="png" data-w="1280" style=""><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: justify;"></span></p><ul style="" class=" list-paddingleft-2"><li><p style="margin-bottom: 20px;">统计脚本: python、golang、java任选<mpchecktext contenteditable="false" id="1580626918847_0.7078589162718225"></mpchecktext></p></li></ul><h2 style="margin-top: 20px; margin-bottom: 15px; padding-top: 10px; font-weight: bold; line-height: 1.5; font-family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 1.45em; border-bottom: 1px solid rgb(238, 238, 238); color: rgb(85, 85, 85); white-space: normal; background-color: rgb(255, 255, 255);">总结<mpchecktext contenteditable="false" id="1580626918848_0.06824419729125131"></mpchecktext></h2><pre style="padding: 10px; color: rgb(77, 77, 76); font-size: 14px; text-align: left; overflow: auto; font-family: consolas, Menlo, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, monospace; background: rgb(247, 247, 247); line-height: 1.6; border-width: initial; border-style: none; border-color: initial; width: 664px;"><p><span style="height: 20px;">日志对于监控系统流量、提升系统性能、发现系统问题等有着十分重要的意义，可以说有些<mpchecktext contenteditable="false" id="1580626918849_0.02452953254678758"></mpchecktext></span></p><p><span style="height: 20px;">日志对于系统</span>的演变来说起着决定性的作用。<mpchecktext contenteditable="false" id="1580626918850_0.05249334606899425"></mpchecktext>所以日志的收集是一项很重要且很有意思的工<mpchecktext contenteditable="false" id="1580626918851_0.06043315134443272"></mpchecktext></p><p>作，也可以说是一门学问，如何规范的输出日志方便后边的收集，如何压缩日志尽量减少磁<mpchecktext contenteditable="false" id="1580626918852_0.9758315067023118"></mpchecktext></p><p>盘的使用，如何控制日志结构使搜索更快等等这些问题。<mpchecktext contenteditable="false" id="1580626918853_0.4393504293723651"></mpchecktext></p><span style="height: 20px;">本文重点分享了当前我采用的收集方式，欢迎大家提出纠正和宝贵的意见。<mpchecktext contenteditable="false" id="1580626918854_0.2286144137314019"></mpchecktext></span></pre></body></html>